{% extends "base.html" %}

{% block content %}
<h2 id="main-header" class="mb-3">Employees</h2>
<section id="dock-content-dashboard" hidden>
  <div class="row g-3">
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Total Employees</div>
          <div class="h5 mb-0">{{ employees|length if employees else 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Active</div>
          <div class="h5 mb-0">
            {% if employees %}{{ employees | selectattr('status', 'equalto', 'Active') | list | length }}{% else %}0{% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Offices</div>
          <div class="h5 mb-0">{% if employees %}{{ employees|groupby('office')|list|length }}{% else %}0{% endif %}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Positions</div>
          <div class="h5 mb-0">{% if employees %}{{ employees|groupby('position')|list|length }}{% else %}0{% endif %}</div>
        </div>
      </div>
    </div>
  </div>
  <p class="mt-3 mb-0 text-muted small">Mock metrics for quick overview. Replace with real KPIs later.</p>
</section>
<section id="dock-content-employees">
        <div class="d-flex justify-content-end mb-3">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            <i class="fas fa-user-plus me-1"></i> Add Employee
          </button>
        </div>

        <div class="mb-3">
            <form method="GET" action="{{ url_for('main.employee_list') }}" class="d-flex">
                <input type="text" name="search" class="form-control me-2" placeholder="Search by name, biometric, office, position, or status..." value="{{ (search_query or '') }}">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                {% if search_query %}
                    <a href="{{ url_for('main.employee_list') }}" class="btn btn-secondary">Reset</a>
                {% endif %}
            </form>
        </div>

        <div class="table-responsive">
            <table id="employeeTable" class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th style="width: 140px;">Biometric</th>
                        <th>Name</th>
                        <th style="width: 180px;">Office</th>
                        <th style="width: 160px;">Position</th>
                        <th style="width: 140px;">Status</th>
                        <th style="width: 160px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if employees %}
                        {% for e in employees %}
                        <tr>
                            <td>{{ e.bio_number }}</td>
                            <td>{{ e.employee_name }}</td>
                            <td>{{ e.office }}</td>
                            <td>
                                <span class="badge {% if e.position == 'Job Order Worker' %}bg-info text-dark{% elif e.position == 'Contract of Service' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ e.position }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {{ 'bg-success' if e.status == 'Active' else 'bg-secondary' }}">
                                    {{ e.status }}
                                </span>
                            </td>
                            <td class="text-nowrap">
                                <button type="button" class="btn btn-sm btn-warning me-1" data-bs-toggle="modal" data-bs-target="#editEmployeeModal-{{ e.id }}" title="Edit">
                                    <i class="fas fa-pen-to-square" aria-hidden="true"></i>
                                    <span class="visually-hidden">Edit</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteEmployeeModal-{{ e.id }}" title="Delete">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                    <span class="visually-hidden">Delete</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No Employee Records Found.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if pagination %}
        <nav aria-label="Employee records pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.employee_list', page=pagination.prev_num, search=search_query) }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.employee_list', page=page_num, search=search_query) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">â€¦</span></li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.employee_list', page=pagination.next_num, search=search_query) }}">Next</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
</section>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('main.add_employee') }}" id="addEmployeeForm">
        {{ form.csrf_token }}
        <div class="modal-header">
          <h5 class="modal-title" id="addEmployeeModalLabel">Add Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ form.bio_number.label(class="form-label") }}
            {{ form.bio_number(class="form-control", id="add-bio-number") }}
            <div class="invalid-feedback" id="add-bio-feedback"></div>
          </div>
          <div class="mb-3">
            {{ form.employee_name.label(class="form-label") }}
            {{ form.employee_name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.office.label(class="form-label") }}
            {{ form.office(class="form-select") }}
          </div>
          <div class="mb-3">
            {{ form.position.label(class="form-label") }}
            {{ form.position(class="form-select") }}
          </div>
          <div class="mb-3">
            {{ form.status.label(class="form-label") }}
            {{ form.status(class="form-select") }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Employee Modals -->
{% for e in employees %}
<div class="modal fade" id="editEmployeeModal-{{ e.id }}" tabindex="-1" aria-labelledby="editEmployeeModalLabel-{{ e.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('main.edit_employee', employee_id=e.id) }}" id="editEmployeeForm-{{ e.id }}">
        {{ form.csrf_token }}
        <div class="modal-header">
          <h5 class="modal-title" id="editEmployeeModalLabel-{{ e.id }}">Edit Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ form.bio_number.label(class="form-label") }}
            {{ form.bio_number(class="form-control", id="edit-bio-number-{{ e.id }}", value=e.bio_number) }}
            <div class="invalid-feedback" id="edit-bio-feedback-{{ e.id }}"></div>
          </div>
          <div class="mb-3">
            {{ form.employee_name.label(class="form-label") }}
            {{ form.employee_name(class="form-control", value=e.employee_name) }}
          </div>
          <div class="mb-3">
            {{ form.office.label(class="form-label") }}
            {{ form.office(class="form-select", value=e.office) }}
          </div>
          <div class="mb-3">
            {{ form.position.label(class="form-label") }}
            {{ form.position(class="form-select", value=e.position) }}
          </div>
          <div class="mb-3">
            {{ form.status.label(class="form-label") }}
            {{ form.status(class="form-select", value=e.status) }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
</div>
  </div>
</div>
<!-- Delete Employee Modal -->
<div class="modal fade" id="deleteEmployeeModal-{{ e.id }}" tabindex="-1" aria-labelledby="deleteEmployeeModalLabel-{{ e.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteEmployeeModalLabel-{{ e.id }}">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this employee record for "{{ e.employee_name }}"? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('main.delete_employee', employee_id=e.id) }}" style="display:inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script>
/* eslint-disable */
(function() {
    const csrfToken = "{{ csrf_token() }}";
    const endpoint = "{{ url_for('main.check_bio_number') }}";

    function setValid(el, feedbackEl) {
        el.classList.remove('is-invalid');
        if (feedbackEl) {
            feedbackEl.textContent = '';
        }
    }
    function setInvalid(el, feedbackEl, msg) {
        el.classList.add('is-invalid');
        if (feedbackEl) {
            feedbackEl.textContent = msg || 'Biometric number is already taken';
        }
    }
    function clearState(el, feedbackEl) {
        el.classList.remove('is-invalid');
        if (feedbackEl) {
            feedbackEl.textContent = '';
        }
    }
    function debounce(fn, delay) {
        let t;
        return function(...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), delay);
        };
    }
    async function checkBio(value, excludeId) {
        const fd = new FormData();
        fd.append('bio_number', value || '');
        if (excludeId) fd.append('exclude_id', String(excludeId));
        fd.append('csrf_token', csrfToken);
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: fd,
            credentials: 'same-origin'
        });
        const data = await res.json();
        return data;
    }

    // Add Employee modal live validation
    const addInput = document.getElementById('add-bio-number');
    const addForm = document.getElementById('addEmployeeForm');
    const addFeedback = document.getElementById('add-bio-feedback');

    if (addInput && addForm) {
        const addHandler = debounce(async function() {
            const val = (addInput.value || '').trim();
            if (!val) { clearState(addInput, addFeedback); return; }
            try {
                const data = await checkBio(val, null);
                if (data && data.valid) {
                    setValid(addInput, addFeedback);
                } else {
                    const msg = (data && data.message) ? data.message : 'Biometric number is already taken';
                    setInvalid(addInput, addFeedback, msg);
                }
            } catch (e) {
                // stay neutral on network errors
                clearState(addInput, addFeedback);
            }
        }, 400);

        addInput.addEventListener('input', function() {
            clearState(addInput, addFeedback);
            addHandler();
        });

        addForm.addEventListener('submit', function(e) {
            if (addInput.classList.contains('is-invalid')) {
                e.preventDefault();
            }
        });
    }

    // Edit Employee modals live validation
    const editInputs = document.querySelectorAll('[id^="edit-bio-number-"]');
    editInputs.forEach(function(inputEl) {
        const suffix = inputEl.id.replace('edit-bio-number-', '');
        const excludeId = parseInt(suffix, 10) || null;
        const feedbackEl = document.getElementById('edit-bio-feedback-' + suffix);
        const formEl = document.getElementById('editEmployeeForm-' + suffix);

        const handler = debounce(async function() {
            const val = (inputEl.value || '').trim();
            if (!val) { clearState(inputEl, feedbackEl); return; }
            try {
                const data = await checkBio(val, excludeId);
                if (data && data.valid) {
                    setValid(inputEl, feedbackEl);
                } else {
                    const msg = (data && data.message) ? data.message : 'Biometric number is already taken';
                    setInvalid(inputEl, feedbackEl, msg);
                }
            } catch (e) {
                clearState(inputEl, feedbackEl);
            }
        }, 400);

        inputEl.addEventListener('input', function() {
            clearState(inputEl, feedbackEl);
            handler();
        });

        if (formEl) {
            formEl.addEventListener('submit', function(e) {
                if (inputEl.classList.contains('is-invalid')) {
                    e.preventDefault();
                }
            });
        }
    });
})();
</script>

<style>
/* Floating dock styles */
.floating-dock-container {
  position: fixed;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  z-index: 1030; /* below Bootstrap modals (1055) but above page content */
  pointer-events: none; /* allow clicks to pass through except on dock */
}
.floating-dock {
  pointer-events: auto;
}
.floating-dock {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 18px;
  padding: 10px 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  border: 1px solid rgba(0,0,0,0.06);
  max-width: min(90vw, 760px);
}
body.dark-mode .floating-dock {
  background: rgba(25,25,25,0.6);
  border-color: rgba(255,255,255,0.08);
}
.dock-item {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.9);
  color: #333;
  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 600;
  font-size: 14px;
  transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
}
.dock-item i { font-size: 16px; }
.dock-item:focus { outline: 2px solid #0d6efd33; outline-offset: 2px; }
.dock-item:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
.dock-item.active {
  background: #0d6efd;
  color: #fff;
  border-color: #0d6efd;
}
body.dark-mode .dock-item { background: rgba(255,255,255,0.08); color: #e6e6e6; border-color: rgba(255,255,255,0.12); }
body.dark-mode .dock-item.active { background: #0d6efd; color: #fff; }

body.dark-mode .floating-dock-panel { background: #1f1f1f; color: #eaeaea; border-color: rgba(255,255,255,0.08); }
.floating-dock-panel.open { display: block; }
.floating-dock-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
body.dark-mode .floating-dock-panel-header { border-color: rgba(255,255,255,0.08); }
.floating-dock-panel-body { padding: 14px; }
.panel-close-btn {
  background: transparent;
  border: none;
  color: inherit;
  padding: 6px;
  border-radius: 8px;
}
.panel-close-btn:hover { background: rgba(0,0,0,0.06); }
body.dark-mode .panel-close-btn:hover { background: rgba(255,255,255,0.08); }

@media (max-width: 576px) {
  .dock-item span { display: none; }
  .floating-dock { gap: 8px; padding: 8px 10px; }
  .docked-icon-only .dock-item span { display: none; }
}
</style>

<div class="floating-dock-container" aria-label="Employee Records Dock">
  <div class="floating-dock" role="tablist" aria-label="Quick actions">
    <button class="dock-item" role="tab" aria-selected="false" id="dock-tab-dashboard" aria-controls="dock-content-dashboard">
      <i class="fas fa-chart-line" aria-hidden="true"></i>
      <span>Dashboard</span>
    </button>
    <button class="dock-item active" role="tab" aria-selected="true" id="dock-tab-employees" aria-controls="dock-content-employees">
      <i class="fas fa-users" aria-hidden="true"></i>
      <span>Employees</span>
    </button>
  </div>

</div>

<script>
/* eslint-disable */
(function() {
  const dock = document.querySelector('.floating-dock');
  const tabs = Array.from(dock ? dock.querySelectorAll('.dock-item') : []);
  const sectionDashboard = document.getElementById('dock-content-dashboard');
  const sectionEmployees = document.getElementById('dock-content-employees');
  const mainHeader = document.getElementById('main-header');

  function setActive(tabEl) {
    tabs.forEach(b => {
      const isActive = b === tabEl;
      b.classList.toggle('active', isActive);
      b.setAttribute('aria-selected', String(isActive));
    });
  }

  function updateSections(tabEl) {
    const showDashboard = tabEl && tabEl.id === 'dock-tab-dashboard';
    if (sectionDashboard) sectionDashboard.hidden = !showDashboard;
    if (sectionEmployees) sectionEmployees.hidden = showDashboard;
    if (mainHeader) {
      const label = tabEl?.querySelector('span')?.textContent || (showDashboard ? 'Dashboard' : 'Employees');
      mainHeader.textContent = label;
    }
  }

  tabs.forEach(b => {
    b.addEventListener('click', () => { setActive(b); updateSections(b); });
    b.addEventListener('keydown', (e) => {
      const idx = tabs.indexOf(b);
      if (e.key === 'ArrowRight') {
        const next = tabs[(idx + 1) % tabs.length];
        next.focus();
        e.preventDefault();
      } else if (e.key === 'ArrowLeft') {
        const prev = tabs[(idx - 1 + tabs.length) % tabs.length];
        prev.focus();
        e.preventDefault();
      } else if (e.key === 'Enter' || e.key === ' ') {
        setActive(b);
        updateSections(b);
        e.preventDefault();
      }
    });
  });

  // Default to Employees section active
  const empTab = document.getElementById('dock-tab-employees') || tabs[0];
  if (empTab) {
    setActive(empTab);
    updateSections(empTab);
  }
})();
</script>
{% endblock %}
