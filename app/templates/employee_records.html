{% extends "base.html" %}

{% block content %}
<h2 id="main-header" class="mb-3">Employees</h2>
<section id="dock-content-dashboard" hidden>
  <div class="row g-3">
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Total Employees</div>
          <div class="h5 mb-0">{{ employees|length if employees else 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Active</div>
          <div class="h5 mb-0">
            {% if employees %}{{ employees | selectattr('status', 'equalto', 'Active') | list | length }}{% else %}0{% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Offices</div>
          <div class="h5 mb-0">{% if employees %}{{ employees|groupby('office')|list|length }}{% else %}0{% endif %}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body p-3">
          <div class="text-muted small">Positions</div>
          <div class="h5 mb-0">{% if employees %}{{ employees|groupby('position')|list|length }}{% else %}0{% endif %}</div>
        </div>
      </div>
    </div>
  </div>
  <p class="mt-3 mb-0 text-muted small">Mock metrics for quick overview. Replace with real KPIs later.</p>
</section>
<section id="dock-content-employees">
        <div class="d-flex justify-content-end mb-3">
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            <i class="fas fa-user-plus me-1"></i> Add Employee
          </button>
        </div>

        <div class="mb-3">
            <form method="GET" action="{{ url_for('main.employee_list') }}" class="d-flex">
                <input type="text" name="search" class="form-control me-2" placeholder="Search by name, biometric, office, position, or status..." value="{{ (search_query or '') }}">
                <button type="submit" class="btn btn-primary me-2">Search</button>
                {% if search_query %}
                    <a href="{{ url_for('main.employee_list') }}" class="btn btn-secondary">Reset</a>
                {% endif %}
            </form>
        </div>

        <div class="table-responsive">
            <table id="employeeTable" class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th style="width: 140px;">Biometric</th>
                        <th>Name</th>
                        <th style="width: 180px;">Office</th>
                        <th style="width: 160px;">Position</th>
                        <th style="width: 140px;">Status</th>
                        <th style="width: 160px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if employees %}
                        {% for e in employees %}
                        <tr data-employee-id="{{ e.id }}">
                            <td>{{ e.bio_number }}</td>
                            <td>{{ e.employee_name }}</td>
                            <td>{{ e.office }}</td>
                            <td>
                                <span class="badge {% if e.position == 'Job Order Worker' %}bg-info text-dark{% elif e.position == 'Contract of Service' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ e.position }}
                                </span>
                            </td>
                            <td>
                                <span class="badge {{ 'bg-success' if e.status == 'Active' else 'bg-secondary' }}">
                                    {{ e.status }}
                                </span>
                            </td>
                            <td class="text-nowrap">
                                <button type="button" class="btn btn-sm btn-info me-1" data-bs-toggle="modal" data-bs-target="#viewEmployeeModal-{{ e.id }}" title="View">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                    <span class="visually-hidden">View</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteEmployeeModal-{{ e.id }}" title="Delete">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                    <span class="visually-hidden">Delete</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No Employee Records Found.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if pagination %}
        <nav aria-label="Employee records pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.employee_list', page=pagination.prev_num, search=search_query) }}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.employee_list', page=page_num, search=search_query) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.employee_list', page=pagination.next_num, search=search_query) }}">Next</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
</section>

<section id="dock-content-tardiness" hidden>
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Tardiness Overview</h5>
        <span class="badge bg-primary text-uppercase">Preview</span>
      </div>
      <p class="text-muted small mb-0">Mock metrics for attendance monitoring. Replace with live data once available.</p>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-sm-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="text-muted small">Average Late Minutes</div>
          <div class="h5 mb-0">18 mins</div>
        </div>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="text-muted small">Employees With Lates</div>
          <div class="h5 mb-0">7</div>
        </div>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body py-3">
          <div class="text-muted small">Most Recent Incident</div>
          <div class="h5 mb-0">2024-11-02</div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Office</th>
          <th>Late Arrivals</th>
          <th>Total Minutes Late</th>
          <th>Last Late</th>
        </tr>
      </thead>
      <tbody>
        {% if tardiness_records is defined and tardiness_records %}
          {% for entry in tardiness_records %}
          <tr>
            <td>{{ entry.employee_name or 'N/A' }}</td>
            <td>{{ entry.office or 'N/A' }}</td>
            <td>{{ entry.late_count or 0 }}</td>
            <td>{{ entry.total_minutes or 0 }}</td>
            <td>{{ entry.last_late or 'N/A' }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">No tardiness records available yet.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('main.add_employee') }}" id="addEmployeeForm">
        {{ form.csrf_token }}
        <div class="modal-header">
          <h5 class="modal-title" id="addEmployeeModalLabel">Add Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ form.bio_number.label(class="form-label") }}
            {{ form.bio_number(class="form-control", id="add-bio-number") }}
            <div class="invalid-feedback" id="add-bio-feedback"></div>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              {{ form.surname.label(class="form-label") }}
              {{ form.surname(class="form-control") }}
            </div>
            <div class="col-md-6">
              {{ form.first_name.label(class="form-label") }}
              {{ form.first_name(class="form-control") }}
            </div>
          </div>
          <div class="mb-3">
            {{ form.office.label(class="form-label") }}
            {{ form.office(class="form-select") }}
          </div>
          <div class="mb-3">
            {{ form.position.label(class="form-label") }}
            {{ form.position(class="form-select") }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Employee Modals -->
{% for e in employees %}
<!-- View Employee Modal (Profile-style with side tabs) -->
<div class="modal fade" id="viewEmployeeModal-{{ e.id }}" tabindex="-1" aria-labelledby="viewEmployeeModalLabel-{{ e.id }}" aria-hidden="true" data-update-url="{{ url_for('main.update_employee_profile', employee_id=e.id) }}">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
    <div class="modal-content profile-modal">
      <div class="modal-header bg-primary text-white">
        <div class="d-flex align-items-center">
          <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center me-3" style="width:48px;height:48px;">
            <i class="fas fa-user"></i>
          </div>
          <div>
            <h5 class="modal-title mb-0" id="viewEmployeeModalLabel-{{ e.id }}">{{ e.employee_name }}</h5>
            <small class="text-white-50">Biometric: {{ e.bio_number }} • {{ e.position }} • {{ e.office }}</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <!-- Side tabs -->
          <div class="col-12 col-md-3">
            <ul class="nav nav-pills flex-md-column gap-2" id="profileTabs-{{ e.id }}" role="tablist" aria-orientation="vertical">
              <li class="nav-item" role="presentation">
                <button class="nav-link active d-flex align-items-center" id="tab-btn-pi-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-pi-{{ e.id }}" type="button" role="tab" aria-controls="tab-pi-{{ e.id }}" aria-selected="true">
                  <i class="fas fa-user me-2"></i> I. Personal Information
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="tab-btn-fb-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-fb-{{ e.id }}" type="button" role="tab" aria-controls="tab-fb-{{ e.id }}" aria-selected="false">
                  <i class="fas fa-users me-2"></i> II. Family Background
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="tab-btn-eb-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-eb-{{ e.id }}" type="button" role="tab" aria-controls="tab-eb-{{ e.id }}" aria-selected="false">
                  <i class="fas fa-graduation-cap me-2"></i> III. Educational Background
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="tab-btn-cse-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-cse-{{ e.id }}" type="button" role="tab" aria-controls="tab-cse-{{ e.id }}" aria-selected="false">
                  <i class="fas fa-id-card me-2"></i> IV. Civil Service Eligibility
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="tab-btn-we-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-we-{{ e.id }}" type="button" role="tab" aria-controls="tab-we-{{ e.id }}" aria-selected="false">
                  <i class="fas fa-briefcase me-2"></i> V. Work Experience
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="tab-btn-vw-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-vw-{{ e.id }}" type="button" role="tab" aria-controls="tab-vw-{{ e.id }}" aria-selected="false">
                  <i class="fas fa-hand-holding-heart me-2"></i> VI. Voluntary Work
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link d-flex align-items-center" id="tab-btn-ld-{{ e.id }}" data-bs-toggle="pill" data-bs-target="#tab-ld-{{ e.id }}" type="button" role="tab" aria-controls="tab-ld-{{ e.id }}" aria-selected="false">
                  <i class="fas fa-chalkboard-teacher me-2"></i> VII. Learning & Development
                </button>
              </li>
            </ul>
          </div>

          <!-- Content area -->
          <div class="col-12 col-md-9">
            <div class="tab-content" id="profileTabsContent-{{ e.id }}">
              <!-- I. Personal Information -->
              <div class="tab-pane fade show active" id="tab-pi-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-pi-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">I. Personal Information</h6>
                    {% set _name_parts = (e.employee_name or '').split(',') %}
                    {% set _fallback_surname = _name_parts[0]|trim if _name_parts|length > 0 else '' %}
                    {% set _fallback_first = _name_parts[1]|trim if _name_parts|length > 1 else '' %}
                    <!-- Personal Information Fields -->
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="text-muted small">Surname</div>
                        <div class="fw-semibold">{{ e.surname or _fallback_surname }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">First Name</div>
                        <div class="fw-semibold">{{ e.first_name or _fallback_first }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Middle Name</div>
                        <div class="fw-semibold">{{ e.middle_name|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Name Extension (Jr., Sr., II, etc.)</div>
                        <div class="fw-semibold">{{ e.name_extension|default('', true) }}</div>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">Date of Birth (mm/dd/yyyy)</div>
                        <div class="fw-semibold">{{ e.date_of_birth|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Place of Birth</div>
                        <div class="fw-semibold">{{ e.place_of_birth|default('', true) }}</div>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">Sex</div>
                        <div class="fw-semibold">{{ e.sex|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Civil Status</div>
                        <div class="fw-semibold">{{ e.civil_status|default('', true) }}</div>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">Height (m)</div>
                        <div class="fw-semibold">{{ e.height_m|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Weight (kg)</div>
                        <div class="fw-semibold">{{ e.weight_kg|default('', true) }}</div>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">Blood Type</div>
                        <div class="fw-semibold">{{ e.blood_type|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Citizenship</div>
                        <div class="fw-semibold">{{ e.citizenship|default('', true) }}</div>
                        <small class="text-muted d-block">{{ e.citizenship_details|default('', true) }}</small>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">GSIS ID No.</div>
                        <div class="fw-semibold">{{ e.gsis_id_no|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">PAG-IBIG ID No.</div>
                        <div class="fw-semibold">{{ e.pagibig_id_no|default('', true) }}</div>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">PhilHealth No.</div>
                        <div class="fw-semibold">{{ e.philhealth_no|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">SSS No.</div>
                        <div class="fw-semibold">{{ e.sss_no|default('', true) }}</div>
                      </div>

                      <div class="col-md-6">
                        <div class="text-muted small">TIN</div>
                        <div class="fw-semibold">{{ e.tin|default('', true) }}</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small">Agency Employee No.</div>
                        <div class="fw-semibold">{{ e.agency_employee_no|default('', true) }}</div>
                      </div>
                    </div>

                    <hr class="my-3"/>

                    <!-- Residential Address -->
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="text-muted small mb-1">Residential Address</div>
                        <div class="row g-2">
                          <div class="col-md-4">
                            <small class="text-muted d-block">House/Block/Lot</small>
                            <div class="fw-semibold">{{ e.res_house_lot|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Street</small>
                            <div class="fw-semibold">{{ e.res_street|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Subdivision/Village</small>
                            <div class="fw-semibold">{{ e.res_subdivision|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Barangay</small>
                            <div class="fw-semibold">{{ e.res_barangay|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">City/Municipality</small>
                            <div class="fw-semibold">{{ e.res_city_municipality|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Province</small>
                            <div class="fw-semibold">{{ e.res_province|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">ZIP Code</small>
                            <div class="fw-semibold">{{ e.res_zip_code|default('', true) }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr class="my-3"/>

                    <!-- Permanent Address -->
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="text-muted small mb-1">Permanent Address</div>
                        <div class="row g-2">
                          <div class="col-md-4">
                            <small class="text-muted d-block">House/Block/Lot</small>
                            <div class="fw-semibold">{{ e.perm_house_lot|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Street</small>
                            <div class="fw-semibold">{{ e.perm_street|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Subdivision/Village</small>
                            <div class="fw-semibold">{{ e.perm_subdivision|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Barangay</small>
                            <div class="fw-semibold">{{ e.perm_barangay|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">City/Municipality</small>
                            <div class="fw-semibold">{{ e.perm_city_municipality|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Province</small>
                            <div class="fw-semibold">{{ e.perm_province|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">ZIP Code</small>
                            <div class="fw-semibold">{{ e.perm_zip_code|default('', true) }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr class="my-3"/>

                    <!-- Contact Information -->
                    <div class="row g-3">
                      <div class="col-md-4">
                        <div class="text-muted small">Telephone No.</div>
                        <div class="fw-semibold">{{ e.telephone_no|default('', true) }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted small">Mobile No.</div>
                        <div class="fw-semibold">{{ e.mobile_no|default('', true) }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted small">E-mail Address</div>
                        <div class="fw-semibold">{{ e.email_address|default('', true) }}</div>
                      </div>
                    </div>

                    <!-- Employment Auto-filled (from existing employee record) -->
                    <div class="mt-4">
                      <h6 class="text-uppercase text-muted small mb-2">Employment Details</h6>
                      <div class="row g-3">
                        <div class="col-md-3">
                          <div class="text-muted small">Biometric</div>
                          <div class="fw-semibold">{{ e.bio_number }}</div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-muted small">Office</div>
                          <div class="fw-semibold">{{ e.office }}</div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-muted small">Position</div>
                          <div>
                            <span class="badge {% if e.position == 'Job Order Worker' %}bg-info text-dark{% elif e.position == 'Contract of Service' %}bg-primary{% else %}bg-secondary{% endif %}">{{ e.position }}</span>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="text-muted small">Status</div>
                          <div>
                            <span class="badge {{ 'bg-success' if e.status == 'Active' else 'bg-secondary' }}">{{ e.status }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- II. Family Background -->
              <div class="tab-pane fade" id="tab-fb-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-fb-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">II. Family Background</h6>
                    <!-- Spouse -->
                    <div class="row g-3">
                      <div class="col-md-3">
                        <div class="text-muted small">Spouse's Surname</div>
                        <div class="fw-semibold" data-family-key="spouse_surname">{{ e.spouse_surname|default('', true) }}</div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-muted small">Spouse's First Name</div>
                        <div class="fw-semibold" data-family-key="spouse_first_name">{{ e.spouse_first_name|default('', true) }}</div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-muted small">Spouse's Middle Name</div>
                        <div class="fw-semibold" data-family-key="spouse_middle_name">{{ e.spouse_middle_name|default('', true) }}</div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-muted small">Spouse's Occupation</div>
                        <div class="fw-semibold" data-family-key="spouse_occupation">{{ e.spouse_occupation|default('', true) }}</div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-muted small">Employer/Business Name</div>
                        <div class="fw-semibold" data-family-key="spouse_employer_name">{{ e.spouse_employer_name|default('', true) }}</div>
                      </div>
                      <div class="col-md-5">
                        <div class="text-muted small">Business Address</div>
                        <div class="fw-semibold" data-family-key="spouse_business_address">{{ e.spouse_business_address|default('', true) }}</div>
                      </div>
                      <div class="col-md-3">
                        <div class="text-muted small">Telephone No.</div>
                        <div class="fw-semibold" data-family-key="spouse_telephone_no">{{ e.spouse_telephone_no|default('', true) }}</div>
                      </div>
                    </div>

                    <hr class="my-3"/>

                    <!-- Parents -->
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="text-muted small mb-1">Father's Name</div>
                        <div class="row g-3">
                          <div class="col-md-3">
                            <small class="text-muted d-block">Surname</small>
                            <div class="fw-semibold" data-family-key="father_surname">{{ e.father_surname|default('', true) }}</div>
                          </div>
                          <div class="col-md-3">
                            <small class="text-muted d-block">First Name</small>
                            <div class="fw-semibold" data-family-key="father_first_name">{{ e.father_first_name|default('', true) }}</div>
                          </div>
                          <div class="col-md-3">
                            <small class="text-muted d-block">Middle Name</small>
                            <div class="fw-semibold" data-family-key="father_middle_name">{{ e.father_middle_name|default('', true) }}</div>
                          </div>
                          <div class="col-md-3">
                            <small class="text-muted d-block">Extension</small>
                            <div class="fw-semibold" data-family-key="father_extension">{{ e.father_extension|default('', true) }}</div>
                          </div>
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="text-muted small mb-1">Mother's Maiden Name</div>
                        <div class="row g-3">
                          <div class="col-md-4">
                            <small class="text-muted d-block">Surname</small>
                            <div class="fw-semibold" data-family-key="mother_maiden_surname">{{ e.mother_maiden_surname|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">First Name</small>
                            <div class="fw-semibold" data-family-key="mother_maiden_first_name">{{ e.mother_maiden_first_name|default('', true) }}</div>
                          </div>
                          <div class="col-md-4">
                            <small class="text-muted d-block">Middle Name</small>
                            <div class="fw-semibold" data-family-key="mother_maiden_middle_name">{{ e.mother_maiden_middle_name|default('', true) }}</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <hr class="my-3"/>

                    <!-- Children -->
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="text-muted small">Names of Children (Name - Date of Birth per line)</div>
                        {% set _children_lines = e.children_info.splitlines() if e.children_info else [] %}
                        <div class="fw-semibold children-info-display" data-family-key="children_info" data-children-raw="{{ e.children_info|default('', true)|replace('\n', '&#10;') }}" data-children='{{ _children_lines|tojson|safe }}'>
                          {% if _children_lines %}
                            <div class="d-flex flex-column gap-2">
                              {% for _child_line in _children_lines %}
                                {% set _parts = _child_line.split(' - ', 1) %}
                                <div class="child-display d-flex flex-wrap gap-2 align-items-baseline">
                                  <span class="fw-semibold">{{ _parts[0]|trim }}</span>
                                  {% if _parts|length > 1 and _parts[1].strip() %}
                                    <span class="text-muted">- {{ _parts[1]|trim }}</span>
                                  {% endif %}
                                </div>
                              {% endfor %}
                            </div>
                          {% else %}
                            <span class="text-muted">No children listed</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- III. Educational Background -->
              <div class="tab-pane fade" id="tab-eb-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-eb-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">III. Educational Background</h6>
                    <div class="education-section">
                      {% set _elem_records = e.elem_records %}
                      <div class="education-level mb-4" data-education-section="elem" data-education-prefix="elem" data-education-label="Elementary" data-education-records='{{ _elem_records|tojson|safe }}'>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="fw-semibold text-primary">Elementary</span>
                        </div>
                        <div class="education-display" data-education-display>
                          {% if _elem_records %}
                            {% for rec in _elem_records %}
                              <div class="education-display-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <div class="text-muted small">Name of School</div>
                                    <div class="fw-semibold">{{ rec.school_name|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="text-muted small">Basic Education/Degree/Course</div>
                                    <div class="fw-semibold">{{ rec.basic_education|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance From</div>
                                    <div class="fw-semibold">{{ rec.period_from|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance To</div>
                                    <div class="fw-semibold">{{ rec.period_to|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Highest Level/Units Earned</div>
                                    <div class="fw-semibold">{{ rec.highest_level|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Year Graduated</div>
                                    <div class="fw-semibold">{{ rec.year_graduated|default('', true) }}</div>
                                  </div>
                                  <div class="col-12">
                                    <div class="text-muted small">Scholarships/Honors Received</div>
                                    <div class="fw-semibold">{{ rec.scholarships|default('', true) }}</div>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="text-muted">No records listed</span>
                          {% endif %}
                        </div>
                      </div>

                      {% set _sec_records = e.sec_records %}
                      <div class="education-level mb-4" data-education-section="sec" data-education-prefix="sec" data-education-label="Secondary" data-education-records='{{ _sec_records|tojson|safe }}'>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="fw-semibold text-primary">Secondary</span>
                        </div>
                        <div class="education-display" data-education-display>
                          {% if _sec_records %}
                            {% for rec in _sec_records %}
                              <div class="education-display-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <div class="text-muted small">Name of School</div>
                                    <div class="fw-semibold">{{ rec.school_name|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="text-muted small">Basic Education/Degree/Course</div>
                                    <div class="fw-semibold">{{ rec.basic_education|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance From</div>
                                    <div class="fw-semibold">{{ rec.period_from|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance To</div>
                                    <div class="fw-semibold">{{ rec.period_to|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Highest Level/Units Earned</div>
                                    <div class="fw-semibold">{{ rec.highest_level|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Year Graduated</div>
                                    <div class="fw-semibold">{{ rec.year_graduated|default('', true) }}</div>
                                  </div>
                                  <div class="col-12">
                                    <div class="text-muted small">Scholarships/Honors Received</div>
                                    <div class="fw-semibold">{{ rec.scholarships|default('', true) }}</div>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="text-muted">No records listed</span>
                          {% endif %}
                        </div>
                      </div>

                      {% set _voc_records = e.voc_records %}
                      <div class="education-level mb-4" data-education-section="voc" data-education-prefix="voc" data-education-label="Vocational / Trade Course" data-education-records='{{ _voc_records|tojson|safe }}'>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="fw-semibold text-primary">Vocational / Trade Course</span>
                        </div>
                        <div class="education-display" data-education-display>
                          {% if _voc_records %}
                            {% for rec in _voc_records %}
                              <div class="education-display-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <div class="text-muted small">Name of School</div>
                                    <div class="fw-semibold">{{ rec.school_name|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="text-muted small">Basic Education/Degree/Course</div>
                                    <div class="fw-semibold">{{ rec.basic_education|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance From</div>
                                    <div class="fw-semibold">{{ rec.period_from|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance To</div>
                                    <div class="fw-semibold">{{ rec.period_to|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Highest Level/Units Earned</div>
                                    <div class="fw-semibold">{{ rec.highest_level|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Year Graduated</div>
                                    <div class="fw-semibold">{{ rec.year_graduated|default('', true) }}</div>
                                  </div>
                                  <div class="col-12">
                                    <div class="text-muted small">Scholarships/Honors Received</div>
                                    <div class="fw-semibold">{{ rec.scholarships|default('', true) }}</div>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="text-muted">No records listed</span>
                          {% endif %}
                        </div>
                      </div>

                      {% set _college_records = e.college_records %}
                      <div class="education-level mb-4" data-education-section="college" data-education-prefix="college" data-education-label="College" data-education-records='{{ _college_records|tojson|safe }}'>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="fw-semibold text-primary">College</span>
                        </div>
                        <div class="education-display" data-education-display>
                          {% if _college_records %}
                            {% for rec in _college_records %}
                              <div class="education-display-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <div class="text-muted small">Name of School</div>
                                    <div class="fw-semibold">{{ rec.school_name|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="text-muted small">Basic Education/Degree/Course</div>
                                    <div class="fw-semibold">{{ rec.basic_education|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance From</div>
                                    <div class="fw-semibold">{{ rec.period_from|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance To</div>
                                    <div class="fw-semibold">{{ rec.period_to|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Highest Level/Units Earned</div>
                                    <div class="fw-semibold">{{ rec.highest_level|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Year Graduated</div>
                                    <div class="fw-semibold">{{ rec.year_graduated|default('', true) }}</div>
                                  </div>
                                  <div class="col-12">
                                    <div class="text-muted small">Scholarships/Honors Received</div>
                                    <div class="fw-semibold">{{ rec.scholarships|default('', true) }}</div>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="text-muted">No records listed</span>
                          {% endif %}
                        </div>
                      </div>

                      {% set _grad_records = e.grad_records %}
                      <div class="education-level" data-education-section="grad" data-education-prefix="grad" data-education-label="Graduate Studies" data-education-records='{{ _grad_records|tojson|safe }}'>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="fw-semibold text-primary">Graduate Studies</span>
                        </div>
                        <div class="education-display" data-education-display>
                          {% if _grad_records %}
                            {% for rec in _grad_records %}
                              <div class="education-display-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                                <div class="row g-3">
                                  <div class="col-md-6">
                                    <div class="text-muted small">Name of School</div>
                                    <div class="fw-semibold">{{ rec.school_name|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="text-muted small">Basic Education/Degree/Course</div>
                                    <div class="fw-semibold">{{ rec.basic_education|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance From</div>
                                    <div class="fw-semibold">{{ rec.period_from|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Attendance To</div>
                                    <div class="fw-semibold">{{ rec.period_to|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Highest Level/Units Earned</div>
                                    <div class="fw-semibold">{{ rec.highest_level|default('', true) }}</div>
                                  </div>
                                  <div class="col-md-3">
                                    <div class="text-muted small">Year Graduated</div>
                                    <div class="fw-semibold">{{ rec.year_graduated|default('', true) }}</div>
                                  </div>
                                  <div class="col-12">
                                    <div class="text-muted small">Scholarships/Honors Received</div>
                                    <div class="fw-semibold">{{ rec.scholarships|default('', true) }}</div>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="text-muted">No records listed</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- IV. Civil Service Eligibility -->
              <div class="tab-pane fade" id="tab-cse-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-cse-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">IV. Civil Service Eligibility</h6>
                    {% set _cse_records = e.civil_service_records %}
                    <div class="civil-service-section" data-cse-section data-cse-records='{{ _cse_records|tojson|safe }}'>
                      <div class="civil-service-display" data-cse-display>
                        {% if _cse_records %}
                          {% for rec in _cse_records %}
                            <div class="civil-service-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <div class="text-muted small">Career Service / RA 1080</div>
                                  <div class="fw-semibold">{{ rec.career_service|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Rating (if applicable)</div>
                                  <div class="fw-semibold">{{ rec.rating|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Date of Examination / Conferment</div>
                                  <div class="fw-semibold">{{ rec.exam_date|default('', true) }}</div>
                                </div>
                                <div class="col-md-6">
                                  <div class="text-muted small">Place of Examination / Conferment</div>
                                  <div class="fw-semibold">{{ rec.exam_place|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">License Number (if applicable)</div>
                                  <div class="fw-semibold">{{ rec.license_number|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Date of Validity</div>
                                  <div class="fw-semibold">{{ rec.license_validity|default('', true) }}</div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        {% else %}
                          <span class="text-muted">No Civil Service Eligibility records listed</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- V. Work Experience -->
              <div class="tab-pane fade" id="tab-we-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-we-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">V. Work Experience</h6>
                    {% set _we_records = e.work_experience_records %}
                    <div class="work-experience-section" data-we-section data-we-records='{{ _we_records|tojson|safe }}'>
                      <div class="work-experience-display" data-we-display>
                        {% if _we_records %}
                          {% for rec in _we_records %}
                            <div class="work-experience-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                              <div class="row g-3">
                                <div class="col-md-3">
                                  <div class="text-muted small">Inclusive Dates (From)</div>
                                  <div class="fw-semibold">{{ rec.inclusive_from|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Inclusive Dates (To)</div>
                                  <div class="fw-semibold">{{ rec.inclusive_to|default('', true) }}</div>
                                </div>
                                <div class="col-md-6">
                                  <div class="text-muted small">Position Title</div>
                                  <div class="fw-semibold">{{ rec.position_title|default('', true) }}</div>
                                </div>
                                <div class="col-md-6">
                                  <div class="text-muted small">Department/Agency/Office/Company</div>
                                  <div class="fw-semibold">{{ rec.department_agency|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Monthly Salary</div>
                                  <div class="fw-semibold">{{ rec.monthly_salary|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Salary Grade & Step Increment</div>
                                  <div class="fw-semibold">{{ rec.salary_grade|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Status of Appointment</div>
                                  <div class="fw-semibold">{{ rec.appointment_status|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Government Service (Y/N)</div>
                                  <div class="fw-semibold">{{ rec.is_gov_service|default('', true) }}</div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        {% else %}
                          <span class="text-muted">No work experience records listed</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- VI. Voluntary Work -->
              <div class="tab-pane fade" id="tab-vw-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-vw-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">VI. Voluntary Work</h6>
                    {% set _vw_records = e.voluntary_work_records %}
                    <div class="voluntary-work-section" data-vw-section data-vw-records='{{ _vw_records|tojson|safe }}'>
                      <div class="voluntary-work-display" data-vw-display>
                        {% if _vw_records %}
                          {% for rec in _vw_records %}
                            <div class="voluntary-work-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <div class="text-muted small">Name of Organization</div>
                                  <div class="fw-semibold">{{ rec.organization_name|default('', true) }}</div>
                                </div>
                                <div class="col-md-6">
                                  <div class="text-muted small">Address</div>
                                  <div class="fw-semibold">{{ rec.organization_address|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Inclusive Dates (From)</div>
                                  <div class="fw-semibold">{{ rec.inclusive_from|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Inclusive Dates (To)</div>
                                  <div class="fw-semibold">{{ rec.inclusive_to|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Number of Hours</div>
                                  <div class="fw-semibold">{{ rec.hours|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Position / Nature of Work</div>
                                  <div class="fw-semibold">{{ rec.position_nature|default('', true) }}</div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        {% else %}
                          <span class="text-muted">No voluntary work records listed</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- VII. Learning & Development -->
              <div class="tab-pane fade" id="tab-ld-{{ e.id }}" role="tabpanel" aria-labelledby="tab-btn-ld-{{ e.id }}">
                <div class="card shadow-sm border-0">
                  <div class="card-body">
                    <h6 class="text-uppercase text-muted small mb-3">VII. Learning &amp; Development (L&amp;D)</h6>
                    {% set _ld_records = e.learning_dev_records %}
                    <div class="learning-dev-section" data-ld-section data-ld-records='{{ _ld_records|tojson|safe }}'>
                      <div class="learning-dev-display" data-ld-display>
                        {% if _ld_records %}
                          {% for rec in _ld_records %}
                            <div class="learning-dev-entry border rounded p-3 {% if not loop.last %}mb-3{% endif %}">
                              <div class="row g-3">
                                <div class="col-md-6">
                                  <div class="text-muted small">Title of Learning and Development Programs</div>
                                  <div class="fw-semibold">{{ rec.program_title|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Type (Managerial/Technical/etc)</div>
                                  <div class="fw-semibold">{{ rec.ld_type|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Number of Hours</div>
                                  <div class="fw-semibold">{{ rec.hours|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Inclusive Dates (From)</div>
                                  <div class="fw-semibold">{{ rec.inclusive_from|default('', true) }}</div>
                                </div>
                                <div class="col-md-3">
                                  <div class="text-muted small">Inclusive Dates (To)</div>
                                  <div class="fw-semibold">{{ rec.inclusive_to|default('', true) }}</div>
                                </div>
                                <div class="col-md-6">
                                  <div class="text-muted small">Conducted / Sponsored By</div>
                                  <div class="fw-semibold">{{ rec.conducted_by|default('', true) }}</div>
                                </div>
                              </div>
                            </div>
                          {% endfor %}
                        {% else %}
                          <span class="text-muted">No learning &amp; development records listed</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <span class="badge {{ 'bg-success' if e.status == 'Active' else 'bg-secondary' }}">
            {{ e.status }}
          </span>
          <form method="POST" action="{{ url_for('main.toggle_employee_status', employee_id=e.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Toggle Status">
              <i class="fas fa-toggle-on me-1"></i> Toggle Status
            </button>
          </form>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button type="button" class="btn btn-primary btn-sm" data-action="toggle-edit" data-employee-id="{{ e.id }}">
            <i class="fas fa-pen-to-square me-1"></i> Edit Details
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Delete Employee Modal -->
<div class="modal fade" id="deleteEmployeeModal-{{ e.id }}" tabindex="-1" aria-labelledby="deleteEmployeeModalLabel-{{ e.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteEmployeeModalLabel-{{ e.id }}">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this employee record for "{{ e.employee_name }}"? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{{ url_for('main.delete_employee', employee_id=e.id) }}" style="display:inline;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Profile Save Confirmation Modal -->
<div class="modal fade" id="profileSaveConfirmModal" tabindex="-1" aria-labelledby="profileSaveConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileSaveConfirmModalLabel">Confirm Save</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="profileSaveConfirmModalBody">
        Are you sure you want to save these changes?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="profileSaveConfirmBtn">Confirm Save</button>
      </div>
    </div>
  </div>
</div>

<script>
/* eslint-disable */
(function() {
    const csrfToken = "{{ csrf_token() }}";
    const endpoint = "{{ url_for('main.check_bio_number') }}";

    function setValid(el, feedbackEl) {
        el.classList.remove('is-invalid');
        if (feedbackEl) {
            feedbackEl.textContent = '';
        }
    }
    function setInvalid(el, feedbackEl, msg) {
        el.classList.add('is-invalid');
        if (feedbackEl) {
            feedbackEl.textContent = msg || 'Biometric number is already taken';
        }
    }
    function clearState(el, feedbackEl) {
        el.classList.remove('is-invalid');
        if (feedbackEl) {
            feedbackEl.textContent = '';
        }
    }
    function debounce(fn, delay) {
        let t;
        return function(...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), delay);
        };
    }
    async function checkBio(value, excludeId) {
        const fd = new FormData();
        fd.append('bio_number', value || '');
        if (excludeId) fd.append('exclude_id', String(excludeId));
        fd.append('csrf_token', csrfToken);
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: fd,
            credentials: 'same-origin'
        });
        const data = await res.json();
        return data;
    }

    // Add Employee modal live validation
    const addInput = document.getElementById('add-bio-number');
    const addForm = document.getElementById('addEmployeeForm');
    const addFeedback = document.getElementById('add-bio-feedback');

    if (addInput && addForm) {
        const addHandler = debounce(async function() {
            const val = (addInput.value || '').trim();
            if (!val) { clearState(addInput, addFeedback); return; }
            try {
                const data = await checkBio(val, null);
                if (data && data.valid) {
                    setValid(addInput, addFeedback);
                } else {
                    const msg = (data && data.message) ? data.message : 'Biometric number is already taken';
                    setInvalid(addInput, addFeedback, msg);
                }
            } catch (e) {
                // stay neutral on network errors
                clearState(addInput, addFeedback);
            }
        }, 400);

        addInput.addEventListener('input', function() {
            clearState(addInput, addFeedback);
            addHandler();
        });

        addForm.addEventListener('submit', function(e) {
            if (addInput.classList.contains('is-invalid')) {
                e.preventDefault();
            }
        });
    }

})();
</script>

<style>
/* Floating dock styles */
.floating-dock-container {
  position: fixed;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  z-index: 1030; /* below Bootstrap modals (1055) but above page content */
  pointer-events: none; /* allow clicks to pass through except on dock */
}
.floating-dock {
  pointer-events: auto;
}
.floating-dock {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 18px;
  padding: 10px 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  border: 1px solid rgba(0,0,0,0.06);
  max-width: min(90vw, 760px);
}
body.dark-mode .floating-dock {
  background: rgba(25,25,25,0.6);
  border-color: rgba(255,255,255,0.08);
}
.dock-item {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.9);
  color: #333;
  border: 1px solid rgba(0,0,0,0.08);
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 600;
  font-size: 14px;
  transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
}
.dock-item i { font-size: 16px; }
.dock-item:focus { outline: 2px solid #0d6efd33; outline-offset: 2px; }
.dock-item:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
.dock-item.active {
  background: #0d6efd;
  color: #fff;
  border-color: #0d6efd;
}
body.dark-mode .dock-item { background: rgba(255,255,255,0.08); color: #e6e6e6; border-color: rgba(255,255,255,0.12); }
body.dark-mode .dock-item.active { background: #0d6efd; color: #fff; }

body.dark-mode .floating-dock-panel { background: #1f1f1f; color: #eaeaea; border-color: rgba(255,255,255,0.08); }
.floating-dock-panel.open { display: block; }
.floating-dock-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
body.dark-mode .floating-dock-panel-header { border-color: rgba(255,255,255,0.08); }
.floating-dock-panel-body { padding: 14px; }
.panel-close-btn {
  background: transparent;
  border: none;
  color: inherit;
  padding: 6px;
  border-radius: 8px;
}
.panel-close-btn:hover { background: rgba(0,0,0,0.06); }
body.dark-mode .panel-close-btn:hover { background: rgba(255,255,255,0.08); }

@media (max-width: 576px) {
  .dock-item span { display: none; }
  .floating-dock { gap: 8px; padding: 8px 10px; }
  .docked-icon-only .dock-item span { display: none; }
}
</style>

<style>
/* Profile modal styles */
.profile-modal .modal-body { padding-top: 1rem; }
.profile-modal .nav-pills .nav-link {
  background: #f8f9fa !important;
  color: #0d6efd !important;
  border: 1px solid rgba(13,110,253,0.25) !important;
  border-radius: 10px;
  padding: 0.5rem 0.75rem;
  font-weight: 600;
}
.profile-modal .nav-pills .nav-link:hover {
  background: #eef4ff !important;
  color: #0b5ed7 !important;
}
.profile-modal .nav-pills .nav-link:focus {
  box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.25) !important;
  outline: none;
}
.profile-modal .nav-pills .nav-link.active {
  background: #0d6efd !important;
  color: #fff !important;
  border-color: #0d6efd !important;
}
.profile-modal .card {
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
.profile-modal .card-body { padding: 1rem 1rem; }
.profile-modal .scribd-embed-placeholder {
  background: linear-gradient(180deg, #f8fafc, #ffffff);
}
@media (max-width: 767.98px) {
  .profile-modal .nav { flex-direction: row !important; overflow-x: auto; }
  .profile-modal .nav .nav-link { white-space: nowrap; }
}
/* Dark theme overrides (using data-theme attribute) */
[data-theme="dark"] .profile-modal .nav-pills .nav-link {
  background: #111827 !important;
  color: #cfe2ff !important;
  border-color: rgba(255,255,255,0.18) !important;
}
[data-theme="dark"] .profile-modal .nav-pills .nav-link:hover {
  background: #0b1320 !important;
  color: #e3f2ff !important;
}
[data-theme="dark"] .profile-modal .nav-pills .nav-link:focus {
  box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.35) !important;
}
[data-theme="dark"] .profile-modal .nav-pills .nav-link.active {
  background: #0d6efd !important;
  color: #fff !important;
  border-color: #0d6efd !important;
}
[data-theme="dark"] .profile-modal .card { background: #1f2937; color: #e5e7eb; }
[data-theme="dark"] .profile-modal .scribd-embed-placeholder { background: linear-gradient(180deg, #111827, #0f172a); }
</style>

<div class="floating-dock-container" aria-label="Employee Records Dock">
  <div class="floating-dock" role="tablist" aria-label="Quick actions">
    <button class="dock-item" role="tab" aria-selected="false" id="dock-tab-dashboard" aria-controls="dock-content-dashboard">
      <i class="fas fa-chart-line" aria-hidden="true"></i>
      <span>Dashboard</span>
    </button>
    <button class="dock-item active" role="tab" aria-selected="true" id="dock-tab-employees" aria-controls="dock-content-employees">
      <i class="fas fa-users" aria-hidden="true"></i>
      <span>Employees</span>
    </button>
    <button class="dock-item" role="tab" aria-selected="false" id="dock-tab-tardiness" aria-controls="dock-content-tardiness">
      <i class="fas fa-user-clock" aria-hidden="true"></i>
      <span>Tardiness</span>
    </button>
  </div>

</div>

<script>
/* eslint-disable */
(function() {
  const dock = document.querySelector('.floating-dock');
  const tabs = Array.from(dock ? dock.querySelectorAll('.dock-item') : []);
  const mainHeader = document.getElementById('main-header');
  const tabSections = tabs.map(tab => {
    const controlsId = tab.getAttribute('aria-controls');
    return {
      tab,
      section: controlsId ? document.getElementById(controlsId) : null
    };
  });

  function setActive(tabEl) {
    tabs.forEach(b => {
      const isActive = b === tabEl;
      b.classList.toggle('active', isActive);
      b.setAttribute('aria-selected', String(isActive));
    });
  }

  function updateSections(tabEl) {
    tabSections.forEach(({ tab, section }) => {
      if (section) section.hidden = tab !== tabEl;
    });

    if (mainHeader) {
      var spanEl = (tabEl && typeof tabEl.querySelector === 'function') ? tabEl.querySelector('span') : null;
      var label = (spanEl && spanEl.textContent) ? spanEl.textContent.trim() : '';
      if (!label) label = 'Employees';
      mainHeader.textContent = label;
    }
  }

  tabs.forEach(b => {
    b.addEventListener('click', () => { setActive(b); updateSections(b); });
    b.addEventListener('keydown', (e) => {
      const idx = tabs.indexOf(b);
      if (e.key === 'ArrowRight') {
        const next = tabs[(idx + 1) % tabs.length];
        next.focus();
        e.preventDefault();
      } else if (e.key === 'ArrowLeft') {
        const prev = tabs[(idx - 1 + tabs.length) % tabs.length];
        prev.focus();
        e.preventDefault();
      } else if (e.key === 'Enter' || e.key === ' ') {
        setActive(b);
        updateSections(b);
        e.preventDefault();
      }
    });
  });

  // Default to Employees section active
  const defaultTab = document.getElementById('dock-tab-employees') || tabs.find(btn => btn.classList.contains('active')) || tabs[0];
  if (defaultTab) {
    setActive(defaultTab);
    updateSections(defaultTab);
  }
})();
</script>
<script>
/* Inline edit for Profile modal across Personal, Address, and Employment sections */
(function() {
  const profileCsrf = "{{ csrf_token() }}";
  const SELECT_CLASS = 'form-select form-select-sm pi-input';
  const INPUT_CLASS = 'form-control form-control-sm pi-input';
  const CHECK_BIO_ENDPOINT = "{{ url_for('main.check_bio_number') }}";
  const OFFICE_CHOICES = (function(){ try { return JSON.parse('{{ (form and form.office and form.office.choices) and (form.office.choices|tojson|safe) or "[]" }}'); } catch(e) { return []; } })();
  const OFFICE_VALUES = (Array.isArray(OFFICE_CHOICES) ? OFFICE_CHOICES.map(c => c[0]) : []);
  const POSITION_CHOICES = ['Job Order Worker', 'Contract of Service'];
  const STATUS_CHOICES = ['Active', 'Inactive'];

  // Reusable helpers
  function createInputControl(desc, value) {
    if (desc.type === 'select') {
      const sel = document.createElement('select');
      sel.className = SELECT_CLASS;
      const options = (desc.options || []);
      options.forEach(function(opt) {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt === '' ? 'Select' : opt;
        if ((value || '') === opt) o.selected = true;
        sel.appendChild(o);
      });
      return sel;
    }
    if (desc.type === 'textarea') {
      const ta = document.createElement('textarea');
      ta.className = 'form-control pi-input';
      ta.rows = desc.rows || 4;
      ta.value = (value || '');
      if (desc.placeholder) ta.placeholder = desc.placeholder;
      if (desc.maxlength) ta.maxLength = desc.maxlength;
      return ta;
    }
    const input = document.createElement('input');
    input.type = desc.inputType || 'text';
    input.className = INPUT_CLASS;
    input.value = (value || '');
    if (desc.placeholder) input.placeholder = desc.placeholder;
    if (desc.maxlength) input.maxLength = desc.maxlength;
    return input;
  }

  function debounce(fn, delay) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  async function checkBio(value, excludeId) {
    const fd = new FormData();
    fd.append('bio_number', value || '');
    if (excludeId) fd.append('exclude_id', String(excludeId));
    fd.append('csrf_token', profileCsrf);
    const res = await fetch(CHECK_BIO_ENDPOINT, {
      method: 'POST',
      headers: { 'X-CSRFToken': profileCsrf },
      body: fd,
      credentials: 'same-origin'
    });
    try { return await res.json(); } catch { return { valid: true }; }
  }

  // Map for Personal Information labels
  const personalFieldMap = {
    'Surname':            { key: 'surname', type: 'text' },
    'First Name':         { key: 'first_name', type: 'text' },
    'Middle Name':        { key: 'middle_name', type: 'text' },
    'Name Extension (Jr., Sr., II, etc.)': { key: 'name_extension', type: 'text' },
    'Date of Birth (mm/dd/yyyy)': { key: 'date_of_birth', type: 'text', placeholder: 'mm/dd/yyyy' },
    'Place of Birth':     { key: 'place_of_birth', type: 'text' },
    'Sex':                { key: 'sex', type: 'select', options: ['', 'Male', 'Female', 'Other'] },
    'Civil Status':       { key: 'civil_status', type: 'select', options: ['', 'Single', 'Married', 'Widowed', 'Separated', 'Other'] },
    'Height (m)':         { key: 'height_m', type: 'text', placeholder: 'e.g., 1.70' },
    'Weight (kg)':        { key: 'weight_kg', type: 'text', placeholder: 'e.g., 65' },
    'Blood Type':         { key: 'blood_type', type: 'select', options: ['', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'] },
    'GSIS ID No.':        { key: 'gsis_id_no', type: 'text' },
    'PAG-IBIG ID No.':    { key: 'pagibig_id_no', type: 'text' },
    'PhilHealth No.':     { key: 'philhealth_no', type: 'text' },
    'SSS No.':            { key: 'sss_no', type: 'text' },
    'TIN':                { key: 'tin', type: 'text' },
    'Agency Employee No.':{ key: 'agency_employee_no', type: 'text' },
    'Citizenship':        { key: 'citizenship', type: 'text' },
    'Telephone No.':      { key: 'telephone_no', type: 'text' },
    'Mobile No.':         { key: 'mobile_no', type: 'text' },
    'E-mail Address':     { key: 'email_address', type: 'text' }
  };

  // Address label -> suffix mapping (we will prefix with res_/perm_)
  const addressLabelToSuffix = {
    'House/Block/Lot': 'house_lot',
    'Street': 'street',
    'Subdivision/Village': 'subdivision',
    'Barangay': 'barangay',
    'City/Municipality': 'city_municipality',
    'Province': 'province',
    'ZIP Code': 'zip_code'
  };

  // Employment label map
  const employmentFieldMap = {
    'Biometric': { key: 'bio_number', type: 'text' }, // add live duplicate verifier
    'Office':    { key: 'office', type: 'select', options: OFFICE_VALUES },
    'Position':  { key: 'position', type: 'select', options: POSITION_CHOICES },
    'Status':    { key: 'status', type: 'select', options: STATUS_CHOICES }
  };

  const familyFieldMap = {
    spouse_surname: { key: 'spouse_surname', type: 'text' },
    spouse_first_name: { key: 'spouse_first_name', type: 'text' },
    spouse_middle_name: { key: 'spouse_middle_name', type: 'text' },
    spouse_occupation: { key: 'spouse_occupation', type: 'text' },
    spouse_employer_name: { key: 'spouse_employer_name', type: 'text' },
    spouse_business_address: { key: 'spouse_business_address', type: 'text', placeholder: 'Street, City / Municipality' },
    spouse_telephone_no: { key: 'spouse_telephone_no', type: 'text', placeholder: 'e.g., (02) 123-4567' },
    father_surname: { key: 'father_surname', type: 'text' },
    father_first_name: { key: 'father_first_name', type: 'text' },
    father_middle_name: { key: 'father_middle_name', type: 'text' },
    father_extension: { key: 'father_extension', type: 'text', placeholder: 'Jr., Sr., III, etc.' },
    mother_maiden_surname: { key: 'mother_maiden_surname', type: 'text' },
    mother_maiden_first_name: { key: 'mother_maiden_first_name', type: 'text' },
    mother_maiden_middle_name: { key: 'mother_maiden_middle_name', type: 'text' },
    children_info: { key: 'children_info', type: 'children' }
  };

  const EDUCATION_LEVELS = [
    { key: 'elem', prefix: 'elem', label: 'Elementary' },
    { key: 'sec', prefix: 'sec', label: 'Secondary' },
    { key: 'voc', prefix: 'voc', label: 'Vocational / Trade Course' },
    { key: 'college', prefix: 'college', label: 'College' },
    { key: 'grad', prefix: 'grad', label: 'Graduate Studies' }
  ];

  const EDUCATION_FIELD_ORDER = [
    'school_name',
    'basic_education',
    'period_from',
    'period_to',
    'highest_level',
    'year_graduated',
    'scholarships'
  ];

  const EDUCATION_FIELD_CONFIG = {
    school_name: { label: 'Name of School', col: 'col-md-6', placeholder: '' },
    basic_education: { label: 'Basic Education/Degree/Course', col: 'col-md-6', placeholder: '' },
    period_from: { label: 'Attendance From', col: 'col-md-3', placeholder: 'mm/yyyy' },
    period_to: { label: 'Attendance To', col: 'col-md-3', placeholder: 'mm/yyyy' },
    highest_level: { label: 'Highest Level/Units Earned', col: 'col-md-3', placeholder: '' },
    year_graduated: { label: 'Year Graduated', col: 'col-md-3', placeholder: 'yyyy' },
    scholarships: { label: 'Scholarships/Honors Received', col: 'col-12', placeholder: '' }
  };

  const EDUCATION_PREFIX_MAP = EDUCATION_LEVELS.reduce(function(acc, level) {
    acc[level.key] = level.prefix;
    return acc;
  }, {});

  const CIVIL_SERVICE_FIELD_ORDER = [
    'career_service',
    'rating',
    'exam_date',
    'exam_place',
    'license_number',
    'license_validity'
  ];

  const CIVIL_SERVICE_FIELD_CONFIG = {
    career_service: {
      label: 'Career Service / RA 1080',
      col: 'col-md-6',
      placeholder: 'e.g., Career Service Professional'
    },
    rating: {
      label: 'Rating (if applicable)',
      col: 'col-md-3',
      placeholder: 'e.g., 82.50'
    },
    exam_date: {
      label: 'Date of Examination / Conferment',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    exam_place: {
      label: 'Place of Examination / Conferment',
      col: 'col-md-6',
      placeholder: 'City / Province'
    },
    license_number: {
      label: 'License Number (if applicable)',
      col: 'col-md-3',
      placeholder: 'e.g., 123456'
    },
    license_validity: {
      label: 'Date of Validity',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    }
  };

  const WORK_EXPERIENCE_FIELD_ORDER = [
    'inclusive_from',
    'inclusive_to',
    'position_title',
    'department_agency',
    'monthly_salary',
    'salary_grade',
    'appointment_status',
    'is_gov_service'
  ];

  const WORK_EXPERIENCE_FIELD_CONFIG = {
    inclusive_from: {
      label: 'Inclusive Dates (From)',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    inclusive_to: {
      label: 'Inclusive Dates (To)',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    position_title: {
      label: 'Position Title',
      col: 'col-md-6',
      placeholder: 'Write in full'
    },
    department_agency: {
      label: 'Department/Agency/Office/Company',
      col: 'col-md-6',
      placeholder: 'Write in full'
    },
    monthly_salary: {
      label: 'Monthly Salary',
      col: 'col-md-3',
      placeholder: 'e.g., 25,000'
    },
    salary_grade: {
      label: 'Salary Grade & Step Increment',
      col: 'col-md-3',
      placeholder: 'e.g., 11-1'
    },
    appointment_status: {
      label: 'Status of Appointment',
      col: 'col-md-3',
      placeholder: 'e.g., Permanent'
    },
    is_gov_service: {
      label: 'Government Service (Y/N)',
      col: 'col-md-3',
      placeholder: 'Y or N'
    }
  };

  const VOLUNTARY_WORK_FIELD_ORDER = [
    'organization_name',
    'organization_address',
    'inclusive_from',
    'inclusive_to',
    'hours',
    'position_nature'
  ];

  const VOLUNTARY_WORK_FIELD_CONFIG = {
    organization_name: {
      label: 'Name of Organization',
      col: 'col-md-6',
      placeholder: 'Write in full'
    },
    organization_address: {
      label: 'Address',
      col: 'col-md-6',
      placeholder: 'Street / City / Province'
    },
    inclusive_from: {
      label: 'Inclusive Dates (From)',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    inclusive_to: {
      label: 'Inclusive Dates (To)',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    hours: {
      label: 'Number of Hours',
      col: 'col-md-3',
      placeholder: 'e.g., 40'
    },
    position_nature: {
      label: 'Position / Nature of Work',
      col: 'col-md-3',
      placeholder: 'e.g., Volunteer Nurse'
    }
  };

  const LEARNING_DEV_FIELD_ORDER = [
    'program_title',
    'ld_type',
    'hours',
    'inclusive_from',
    'inclusive_to',
    'conducted_by'
  ];

  const LEARNING_DEV_FIELD_CONFIG = {
    program_title: {
      label: 'Title of Learning and Development Programs',
      col: 'col-md-6',
      placeholder: 'Write in full'
    },
    ld_type: {
      label: 'Type (Managerial/Technical/etc)',
      col: 'col-md-3',
      placeholder: 'e.g., Technical'
    },
    hours: {
      label: 'Number of Hours',
      col: 'col-md-3',
      placeholder: 'e.g., 24'
    },
    inclusive_from: {
      label: 'Inclusive Dates (From)',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    inclusive_to: {
      label: 'Inclusive Dates (To)',
      col: 'col-md-3',
      placeholder: 'mm/dd/yyyy'
    },
    conducted_by: {
      label: 'Conducted / Sponsored By',
      col: 'col-md-6',
      placeholder: 'Agency / Organization'
    }
  };

  function parseChildrenEntries(source) {
    if (!source) return [];
    if (Array.isArray(source)) {
      return source.map(function(item) {
        if (typeof item === 'string') {
          const parts = item.split(' - ');
          return {
            name: (parts[0] || '').trim(),
            dob: parts.length > 1 ? (parts[1] || '').trim() : ''
          };
        }
        if (item && typeof item === 'object') {
          return {
            name: (item.name || '').trim(),
            dob: (item.dob || '').trim()
          };
        }
        return { name: '', dob: '' };
      }).filter(function(entry) { return entry.name || entry.dob; });
    }
    return String(source).split(/\r?\n/).map(function(line) {
      const trimmed = line.trim();
      if (!trimmed) return null;
      const parts = trimmed.split(' - ');
      return {
        name: (parts[0] || '').trim(),
        dob: parts.length > 1 ? (parts[1] || '').trim() : ''
      };
    }).filter(Boolean);
  }

  function getChildrenEntries(container) {
    if (!container) return [];
    let entries = [];
    const json = container.getAttribute('data-children');
    if (json) {
      try {
        const parsed = JSON.parse(json);
        if (Array.isArray(parsed)) {
          entries = parseChildrenEntries(parsed);
        }
      } catch (e) {
        entries = [];
      }
    }
    if (!entries.length) {
      const raw = container.getAttribute('data-children-raw') || '';
      entries = parseChildrenEntries(raw);
    }
    return entries;
  }

  function formatDateWithSlashes(value) {
    const digits = (value || '').replace(/\D/g, '').slice(0, 8);
    if (!digits) return '';
    if (digits.length <= 2) return digits;
    if (digits.length <= 4) return digits.slice(0, 2) + '/' + digits.slice(2);
    return digits.slice(0, 2) + '/' + digits.slice(2, 4) + '/' + digits.slice(4);
  }

  function attachDateMaskFormatter(input) {
    if (!input || input.getAttribute('data-has-date-mask') === '1') return;
    input.setAttribute('data-has-date-mask', '1');
    input.addEventListener('input', function() {
      const prevValue = input.value || '';
      const caretPos = input.selectionStart || 0;
      const digitsBeforeCaret = prevValue.slice(0, caretPos).replace(/\D/g, '').length;
      const formatted = formatDateWithSlashes(prevValue);
      input.value = formatted;

      // restore caret close to original digit position
      let newCaret = formatted.length;
      let digitCount = 0;
      for (let i = 0; i < formatted.length; i++) {
        if (/\d/.test(formatted[i])) {
          digitCount += 1;
        }
        if (digitCount >= digitsBeforeCaret) {
          newCaret = i + 1;
          break;
        }
      }
      try {
        input.setSelectionRange(newCaret, newCaret);
      } catch (e) {}
    });
  }

  function isValidChildDob(value) {
    if (!value) return true;
    const match = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(value);
    if (!match) return false;
    const month = parseInt(match[1], 10);
    const day = parseInt(match[2], 10);
    const year = parseInt(match[3], 10);
    if (month < 1 || month > 12) return false;
    if (day < 1 || day > 31) return false;
    const date = new Date(year, month - 1, day);
    if (date.getFullYear() !== year || (date.getMonth() + 1) !== month || date.getDate() !== day) {
      return false;
    }
    return true;
  }

  function attachChildRowValidation(row) {
    const dobInput = row.querySelector('.child-dob-input');
    if (!dobInput) return;

    function applyValidity(strict) {
      const value = (dobInput.value || '').trim();
      if (!value) {
        dobInput.classList.remove('is-invalid');
        dobInput.removeAttribute('title');
        return;
      }
      const formatted = formatDateWithSlashes(value);
      if (formatted !== value) {
        dobInput.value = formatted;
      }
      if (formatted.length < 10 && !strict) {
        dobInput.classList.remove('is-invalid');
        dobInput.removeAttribute('title');
        return;
      }
      if (!isValidChildDob(formatted)) {
        dobInput.classList.add('is-invalid');
        dobInput.setAttribute('title', 'Enter a valid date in mm/dd/yyyy format');
      } else {
        dobInput.classList.remove('is-invalid');
        dobInput.removeAttribute('title');
      }
    }

    dobInput.addEventListener('blur', function() { applyValidity(true); });
    dobInput.addEventListener('change', function() { applyValidity(true); });
    dobInput.addEventListener('input', function() { applyValidity(false); });
    applyValidity(true);
  }

  function addChildRow(wrapper, name, dob) {
    const row = document.createElement('div');
    row.className = 'child-row d-flex flex-wrap align-items-center gap-2';

    const nameWrap = document.createElement('div');
    nameWrap.className = 'flex-grow-1';
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'form-control form-control-sm pi-input child-name-input';
    nameInput.placeholder = 'Full name';
    nameInput.value = name || '';
    nameInput.setAttribute('data-child-input', '1');
    nameWrap.appendChild(nameInput);

    const dobWrap = document.createElement('div');
    dobWrap.className = 'flex-grow-1';
    const dobInput = document.createElement('input');
    dobInput.type = 'text';
    dobInput.className = 'form-control form-control-sm pi-input child-dob-input';
    dobInput.placeholder = 'Date of birth (mm/dd/yyyy)';
    dobInput.value = dob ? formatDateWithSlashes(dob) : '';
    dobInput.setAttribute('data-child-input', '1');
    attachDateMaskFormatter(dobInput);
    dobWrap.appendChild(dobInput);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm child-remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
    removeBtn.addEventListener('click', function() {
      wrapper.removeChild(row);
      if (!wrapper.querySelector('.child-row')) {
        addChildRow(wrapper, '', '');
      }
    });

    row.appendChild(nameWrap);
    row.appendChild(dobWrap);
    row.appendChild(removeBtn);
    wrapper.appendChild(row);
    attachChildRowValidation(row);
    return row;
  }

  function setupChildrenEditor(container) {
    if (!container) return;
    const originalRaw = container.getAttribute('data-children-raw') || '';
    container.setAttribute('data-original-text', originalRaw);
    container.setAttribute('data-children-editor', '1');
    container.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.className = 'children-edit-wrapper d-flex flex-column gap-2';
    container.appendChild(wrapper);

    let entries = getChildrenEntries(container);
    if (!entries.length) {
      entries = [{ name: '', dob: '' }];
    }
    entries.forEach(function(entry) {
      addChildRow(wrapper, entry.name, entry.dob);
    });

    const controls = document.createElement('div');
    controls.className = 'mt-2';
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-outline-secondary btn-sm';
    addBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Child';
    addBtn.addEventListener('click', function() {
      addChildRow(wrapper, '', '');
    });
    controls.appendChild(addBtn);
    container.appendChild(controls);
  }

  function collectChildrenValue(container) {
    if (!container) return '';
    const wrapper = container.querySelector('.children-edit-wrapper');
    if (!wrapper) return '';
    const rows = wrapper.querySelectorAll('.child-row');
    const lines = [];
    rows.forEach(function(row) {
      const nameInput = row.querySelector('.child-name-input');
      const dobInput = row.querySelector('.child-dob-input');
      const nameVal = nameInput ? (nameInput.value || '').trim() : '';
      let dobVal = '';
      if (dobInput) {
        dobVal = formatDateWithSlashes(dobInput.value || '');
        if (dobVal !== (dobInput.value || '')) {
          dobInput.value = dobVal;
        }
        if (dobVal && !isValidChildDob(dobVal)) {
          dobInput.classList.add('is-invalid');
          dobInput.setAttribute('title', 'Enter a valid date in mm/dd/yyyy format');
        } else if (!dobVal) {
          dobInput.classList.remove('is-invalid');
          dobInput.removeAttribute('title');
        } else {
          dobInput.classList.remove('is-invalid');
          dobInput.removeAttribute('title');
        }
      }
      if (nameVal || dobVal) {
        let line = nameVal;
        if (dobVal) {
          line = nameVal ? (nameVal + ' - ' + dobVal) : dobVal;
        }
        lines.push(line);
      }
    });
    return lines.join('\n');
  }

  function renderChildrenDisplay(container, rawValue) {
    if (!container) return;
    const normalized = (rawValue || '').replace(/\r\n/g, '\n');
    container.innerHTML = '';
    container.removeAttribute('data-children-editor');
    container.removeAttribute('data-original-text');
    container.setAttribute('data-children-raw', normalized);
    const lines = normalized ? normalized.split('\n').map(function(line) { return line.trim(); }).filter(Boolean) : [];
    container.setAttribute('data-children', JSON.stringify(lines));

    if (!lines.length) {
      const emptyMsg = document.createElement('span');
      emptyMsg.className = 'text-muted';
      emptyMsg.textContent = 'No children listed';
      container.appendChild(emptyMsg);
      return;
    }

    const list = document.createElement('div');
    list.className = 'd-flex flex-column gap-2';
    lines.forEach(function(line) {
      const parts = line.split(' - ');
      const row = document.createElement('div');
      row.className = 'child-display d-flex flex-wrap gap-2 align-items-baseline';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'fw-semibold';
      nameSpan.textContent = (parts[0] || '').trim();
      row.appendChild(nameSpan);

      if (parts.length > 1 && parts[1] && parts[1].trim()) {
        const dobSpan = document.createElement('span');
        dobSpan.className = 'text-muted';
        dobSpan.textContent = '- ' + parts[1].trim();
        row.appendChild(dobSpan);
      }
      list.appendChild(row);
    });

    container.appendChild(list);
  }

  function getEducationDbKey(levelKey, field) {
    const prefix = EDUCATION_PREFIX_MAP[levelKey];
    if (!prefix) return null;
    return prefix + '_' + field;
  }

  function normalizeEducationEntries(entries) {
    if (!Array.isArray(entries)) return [];
    const normalized = [];
    entries.forEach(function(entry) {
      if (!entry || typeof entry !== 'object') return;
      const normalizedEntry = {};
      let hasValue = false;
      EDUCATION_FIELD_ORDER.forEach(function(field) {
        let value = entry[field];
        if (typeof value === 'number') value = String(value);
        if (typeof value !== 'string') value = value ? String(value) : '';
        value = value.trim();
        if (value) hasValue = true;
        normalizedEntry[field] = value;
      });
      if (hasValue) {
        normalized.push(normalizedEntry);
      }
    });
    return normalized;
  }

  function parseEducationRecordsAttr(section) {
    if (!section) return [];
    const raw = section.getAttribute('data-education-records');
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return normalizeEducationEntries(parsed);
    } catch (e) {
      return [];
    }
  }

  function renderEducationDisplay(section, entries) {
    if (!section) return;
    const normalized = normalizeEducationEntries(entries);
    const display = section.querySelector('[data-education-display]');
    if (display) {
      display.innerHTML = '';
      if (!normalized.length) {
        const emptyMsg = document.createElement('span');
        emptyMsg.className = 'text-muted';
        emptyMsg.textContent = 'No records listed';
        display.appendChild(emptyMsg);
      } else {
        normalized.forEach(function(entry, index) {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'education-display-entry border rounded p-3';
          if (index !== normalized.length - 1) entryDiv.classList.add('mb-3');
          const row = document.createElement('div');
          row.className = 'row g-3';
          EDUCATION_FIELD_ORDER.forEach(function(field) {
            const config = EDUCATION_FIELD_CONFIG[field];
            if (!config) return;
            const col = document.createElement('div');
            col.className = config.col;
            const label = document.createElement('div');
            label.className = 'text-muted small';
            label.textContent = config.label;
            const valueEl = document.createElement('div');
            valueEl.className = 'fw-semibold';
            valueEl.textContent = entry[field] || '';
            col.appendChild(label);
            col.appendChild(valueEl);
            row.appendChild(col);
          });
          entryDiv.appendChild(row);
          display.appendChild(entryDiv);
        });
      }
    }
    section.setAttribute('data-education-records', JSON.stringify(normalized));
  }

  function addEducationRow(wrapper, levelKey, record, index, focus) {
    const entryContainer = document.createElement('div');
    entryContainer.className = 'education-entry-row border rounded p-3';
    if (wrapper.querySelector('[data-education-entry]')) {
      entryContainer.classList.add('mt-2');
    }
    entryContainer.setAttribute('data-education-entry', '1');

    const row = document.createElement('div');
    row.className = 'row g-3';
    entryContainer.appendChild(row);

    EDUCATION_FIELD_ORDER.forEach(function(field) {
      const config = EDUCATION_FIELD_CONFIG[field];
      if (!config) return;
      const col = document.createElement('div');
      col.className = config.col;
      const label = document.createElement('div');
      label.className = 'text-muted small';
      label.textContent = config.label;
      const valueWrap = document.createElement('div');
      const value = (record && record[field]) ? String(record[field]).trim() : '';
      valueWrap.setAttribute('data-original-text', value);
      const inputDesc = { type: 'text' };
      if (config.placeholder) inputDesc.placeholder = config.placeholder;
      const input = createInputControl(inputDesc, value);
      input.classList.add('education-input');
      input.setAttribute('data-education-level', levelKey);
      input.setAttribute('data-education-field', field);
      input.setAttribute('data-education-index', typeof index === 'number' ? String(index) : '');
      if (typeof index === 'number' && index === 0) {
        const dbKey = getEducationDbKey(levelKey, field);
        if (dbKey) input.setAttribute('data-key', dbKey);
      }
      valueWrap.appendChild(input);
      col.appendChild(label);
      col.appendChild(valueWrap);
      row.appendChild(col);
    });

    const actionsCol = document.createElement('div');
    actionsCol.className = 'col-12 d-flex justify-content-end';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm education-remove-btn';
    removeBtn.setAttribute('data-education-remove', '1');
    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
    removeBtn.addEventListener('click', function() {
      const parent = entryContainer.parentElement;
      if (parent) {
        parent.removeChild(entryContainer);
        if (!parent.querySelector('[data-education-entry]')) {
          addEducationRow(parent, levelKey, {}, 0, true);
        }
        renumberEducationRows(parent, levelKey);
      }
    });
    actionsCol.appendChild(removeBtn);
    row.appendChild(actionsCol);

    wrapper.appendChild(entryContainer);

    if (focus) {
      const firstInput = entryContainer.querySelector('.education-input');
      if (firstInput) {
        try { firstInput.focus(); } catch (e) {}
      }
    }
    return entryContainer;
  }

  function renumberEducationRows(wrapper, levelKey) {
    const rows = Array.from(wrapper.querySelectorAll('[data-education-entry]'));
    rows.forEach(function(row, idx) {
      row.setAttribute('data-education-index', String(idx));
      const removeBtn = row.querySelector('[data-education-remove]');
      if (removeBtn) {
        if (rows.length <= 1) {
          removeBtn.classList.add('d-none');
        } else {
          removeBtn.classList.remove('d-none');
        }
      }
      const inputs = row.querySelectorAll('.education-input');
      inputs.forEach(function(input) {
        input.setAttribute('data-education-index', String(idx));
        const field = input.getAttribute('data-education-field');
        const dbKey = getEducationDbKey(levelKey, field);
        if (idx === 0 && dbKey) {
          input.setAttribute('data-key', dbKey);
        } else {
          input.removeAttribute('data-key');
        }
      });
    });
  }

  function setupEducationEditor(section) {
    if (!section || section.getAttribute('data-editing') === '1') return;
    const levelKey = section.getAttribute('data-education-section');
    if (!levelKey) return;
    const records = parseEducationRecordsAttr(section);
    const workingRecords = records.length ? records : [{}];
    section.setAttribute('data-editing', '1');
    section.setAttribute('data-original-json', JSON.stringify(records));

    const display = section.querySelector('[data-education-display]');
    if (display) display.style.display = 'none';

    const existingWrapper = section.querySelector('[data-education-edit-wrapper]');
    if (existingWrapper) existingWrapper.remove();
    const existingControls = section.querySelector('[data-education-controls]');
    if (existingControls) existingControls.remove();

    const editWrapper = document.createElement('div');
    editWrapper.className = 'education-edit-wrapper d-flex flex-column';
    editWrapper.setAttribute('data-education-edit-wrapper', '1');
    section.appendChild(editWrapper);

    workingRecords.forEach(function(record, index) {
      addEducationRow(editWrapper, levelKey, record, index, false);
    });
    renumberEducationRows(editWrapper, levelKey);

    const controls = document.createElement('div');
    controls.className = 'mt-2';
    controls.setAttribute('data-education-controls', '1');
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-outline-secondary btn-sm';
    addBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add School';
    addBtn.addEventListener('click', function() {
      const currentRows = editWrapper.querySelectorAll('[data-education-entry]').length;
      addEducationRow(editWrapper, levelKey, {}, currentRows, true);
      renumberEducationRows(editWrapper, levelKey);
    });
    controls.appendChild(addBtn);
    section.appendChild(controls);
  }

  function enterEducationSections(ebCardBody) {
    if (!ebCardBody) return;
    const sections = ebCardBody.querySelectorAll('[data-education-section]');
    sections.forEach(function(section) {
      setupEducationEditor(section);
    });
  }

  function getEducationEntriesFromSection(section) {
    if (!section) return [];
    const editWrapper = section.querySelector('[data-education-edit-wrapper]');
    if (!editWrapper) {
      return parseEducationRecordsAttr(section);
    }
    const rows = Array.from(editWrapper.querySelectorAll('[data-education-entry]'));
    const entries = rows.map(function(row) {
      const entry = {};
      EDUCATION_FIELD_ORDER.forEach(function(field) {
        const input = row.querySelector('.education-input[data-education-field="' + field + '"]');
        entry[field] = input ? (input.value || '').trim() : '';
      });
      return entry;
    });
    return normalizeEducationEntries(entries);
  }

  function collectEducationData(modal) {
    const result = {};
    if (!modal) return result;
    const sections = modal.querySelectorAll('[data-education-section]');
    sections.forEach(function(section) {
      const levelKey = section.getAttribute('data-education-section');
      if (!levelKey) return;
      result[levelKey] = getEducationEntriesFromSection(section);
    });
    return result;
  }

  function normalizeCivilServiceEntries(entries) {
    if (!Array.isArray(entries)) return [];
    const normalized = [];
    entries.forEach(function(entry) {
      if (!entry || typeof entry !== 'object') return;
      const normalizedEntry = {};
      let hasValue = false;
      CIVIL_SERVICE_FIELD_ORDER.forEach(function(field) {
        let value = entry[field];
        if (typeof value === 'number') value = String(value);
        if (typeof value !== 'string') value = value ? String(value) : '';
        value = value.trim();
        if (value) hasValue = true;
        normalizedEntry[field] = value;
      });
      if (hasValue) normalized.push(normalizedEntry);
    });
    return normalized;
  }

  function parseCivilServiceRecordsAttr(section) {
    if (!section) return [];
    const raw = section.getAttribute('data-cse-records');
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return normalizeCivilServiceEntries(parsed);
    } catch (e) {
      return [];
    }
  }

  function renderCivilServiceDisplay(section, entries) {
    if (!section) return;
    const normalized = normalizeCivilServiceEntries(entries);
    const display = section.querySelector('[data-cse-display]');
    if (display) {
      display.innerHTML = '';
      if (!normalized.length) {
        const empty = document.createElement('span');
        empty.className = 'text-muted';
        empty.textContent = 'No Civil Service Eligibility records listed';
        display.appendChild(empty);
      } else {
        normalized.forEach(function(entry, idx) {
          const wrapper = document.createElement('div');
          wrapper.className = 'civil-service-entry border rounded p-3';
          if (idx !== normalized.length - 1) wrapper.classList.add('mb-3');
          const row = document.createElement('div');
          row.className = 'row g-3';
          CIVIL_SERVICE_FIELD_ORDER.forEach(function(field) {
            const config = CIVIL_SERVICE_FIELD_CONFIG[field];
            if (!config) return;
            const col = document.createElement('div');
            col.className = config.col;
            const label = document.createElement('div');
            label.className = 'text-muted small';
            label.textContent = config.label;
            const valueEl = document.createElement('div');
            valueEl.className = 'fw-semibold';
            valueEl.textContent = entry[field] || '';
            col.appendChild(label);
            col.appendChild(valueEl);
            row.appendChild(col);
          });
          wrapper.appendChild(row);
          display.appendChild(wrapper);
        });
      }
    }
    section.setAttribute('data-cse-records', JSON.stringify(normalized));
  }

  function addCivilServiceRow(wrapper, record, index, focus) {
    const entryContainer = document.createElement('div');
    entryContainer.className = 'civil-service-entry border rounded p-3';
    if (wrapper.querySelector('[data-cse-entry]')) {
      entryContainer.classList.add('mt-2');
    }
    entryContainer.setAttribute('data-cse-entry', '1');

    const row = document.createElement('div');
    row.className = 'row g-3';
    entryContainer.appendChild(row);

    CIVIL_SERVICE_FIELD_ORDER.forEach(function(field) {
      const config = CIVIL_SERVICE_FIELD_CONFIG[field];
      if (!config) return;
      const col = document.createElement('div');
      col.className = config.col;
      const label = document.createElement('div');
      label.className = 'text-muted small';
      label.textContent = config.label;
      const valueWrap = document.createElement('div');
      const value = (record && record[field]) ? String(record[field]).trim() : '';
      valueWrap.setAttribute('data-original-text', value);
      const inputDesc = { type: 'text' };
      if (config.placeholder) inputDesc.placeholder = config.placeholder;
      const input = createInputControl(inputDesc, value);
      input.classList.add('civil-service-input');
      input.setAttribute('data-cse-field', field);
      input.setAttribute('data-cse-index', typeof index === 'number' ? String(index) : '');
      valueWrap.appendChild(input);
      col.appendChild(label);
      col.appendChild(valueWrap);
      row.appendChild(col);
    });

    const actionsCol = document.createElement('div');
    actionsCol.className = 'col-12 d-flex justify-content-end';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm cse-remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
    removeBtn.addEventListener('click', function() {
      const parent = entryContainer.parentElement;
      if (parent) {
        parent.removeChild(entryContainer);
        if (!parent.querySelector('[data-cse-entry]')) {
          addCivilServiceRow(parent, {}, 0, true);
        }
        renumberCivilServiceRows(parent);
      }
    });
    actionsCol.appendChild(removeBtn);
    row.appendChild(actionsCol);

    wrapper.appendChild(entryContainer);

    if (focus) {
      const firstInput = entryContainer.querySelector('.civil-service-input');
      if (firstInput) {
        try { firstInput.focus(); } catch (e) {}
      }
    }
  }

  function renumberCivilServiceRows(wrapper) {
    const rows = Array.from(wrapper.querySelectorAll('[data-cse-entry]'));
    rows.forEach(function(row, idx) {
      row.setAttribute('data-cse-index', String(idx));
      const removeBtn = row.querySelector('.cse-remove-btn');
      if (removeBtn) {
        if (rows.length <= 1) {
          removeBtn.classList.add('d-none');
        } else {
          removeBtn.classList.remove('d-none');
        }
      }
      const inputs = row.querySelectorAll('.civil-service-input');
      inputs.forEach(function(input) {
        input.setAttribute('data-cse-index', String(idx));
      });
    });
  }

  function setupCivilServiceEditor(section) {
    if (!section || section.getAttribute('data-cse-editing') === '1') return;
    const records = parseCivilServiceRecordsAttr(section);
    const workingRecords = records.length ? records : [{}];
    section.setAttribute('data-cse-editing', '1');
    section.setAttribute('data-cse-original-json', JSON.stringify(records));

    const display = section.querySelector('[data-cse-display]');
    if (display) display.style.display = 'none';

    const existingWrapper = section.querySelector('[data-cse-edit-wrapper]');
    if (existingWrapper) existingWrapper.remove();
    const existingControls = section.querySelector('[data-cse-controls]');
    if (existingControls) existingControls.remove();

    const editWrapper = document.createElement('div');
    editWrapper.className = 'civil-service-edit-wrapper d-flex flex-column';
    editWrapper.setAttribute('data-cse-edit-wrapper', '1');
    section.appendChild(editWrapper);

    workingRecords.forEach(function(record, index) {
      addCivilServiceRow(editWrapper, record, index, false);
    });
    renumberCivilServiceRows(editWrapper);

    const controls = document.createElement('div');
    controls.className = 'mt-2';
    controls.setAttribute('data-cse-controls', '1');
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-outline-secondary btn-sm';
    addBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Eligibility';
    addBtn.addEventListener('click', function() {
      const currentRows = editWrapper.querySelectorAll('[data-cse-entry]').length;
      addCivilServiceRow(editWrapper, {}, currentRows, true);
      renumberCivilServiceRows(editWrapper);
    });
    controls.appendChild(addBtn);
    section.appendChild(controls);
  }

  function getCivilServiceEntries(section) {
    if (!section) return [];
    const editWrapper = section.querySelector('[data-cse-edit-wrapper]');
    if (!editWrapper) {
      return parseCivilServiceRecordsAttr(section);
    }
    const rows = Array.from(editWrapper.querySelectorAll('[data-cse-entry]'));
    const entries = rows.map(function(row) {
      const entry = {};
      CIVIL_SERVICE_FIELD_ORDER.forEach(function(field) {
        const input = row.querySelector('.civil-service-input[data-cse-field="' + field + '"]');
        entry[field] = input ? (input.value || '').trim() : '';
      });
      return entry;
    });
    return normalizeCivilServiceEntries(entries);
  }

  function collectCivilServiceData(modal) {
    if (!modal) return null;
    const section = modal.querySelector('[data-cse-section]');
    if (!section) return null;
    if (!section.querySelector('[data-cse-edit-wrapper]')) return null;
    return getCivilServiceEntries(section);
  }

  function exitCivilServiceSection(section, updatedMap) {
    if (!section) return;
    let records = [];
    if (updatedMap && Object.prototype.hasOwnProperty.call(updatedMap, 'civil_service_records_json')) {
      const raw = updatedMap['civil_service_records_json'];
      let parsed = [];
      if (typeof raw === 'string') {
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          parsed = [];
        }
      } else if (Array.isArray(raw)) {
        parsed = raw;
      } else if (raw && typeof raw === 'object') {
        parsed = [raw];
      }
      records = normalizeCivilServiceEntries(parsed);
    } else {
      records = parseCivilServiceRecordsAttr(section);
    }
    const editWrapper = section.querySelector('[data-cse-edit-wrapper]');
    if (editWrapper) editWrapper.remove();
    const controls = section.querySelector('[data-cse-controls]');
    if (controls) controls.remove();
    section.removeAttribute('data-cse-editing');
    section.removeAttribute('data-cse-original-json');
    const display = section.querySelector('[data-cse-display]');
    if (display) display.style.display = '';
    renderCivilServiceDisplay(section, records);
  }

  function normalizeWorkExperienceEntries(entries) {
    if (!Array.isArray(entries)) return [];
    const normalized = [];
    entries.forEach(function(entry) {
      if (!entry || typeof entry !== 'object') return;
      const normalizedEntry = {};
      let hasValue = false;
      WORK_EXPERIENCE_FIELD_ORDER.forEach(function(field) {
        let value = entry[field];
        if (typeof value === 'number') value = String(value);
        if (typeof value !== 'string') value = value ? String(value) : '';
        value = value.trim();
        if (value) hasValue = true;
        normalizedEntry[field] = value;
      });
      if (hasValue) normalized.push(normalizedEntry);
    });
    return normalized;
  }

  function parseWorkExperienceRecordsAttr(section) {
    if (!section) return [];
    const raw = section.getAttribute('data-we-records');
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return normalizeWorkExperienceEntries(parsed);
    } catch (e) {
      return [];
    }
  }

  function renderWorkExperienceDisplay(section, entries) {
    if (!section) return;
    const normalized = normalizeWorkExperienceEntries(entries);
    const display = section.querySelector('[data-we-display]');
    if (display) {
      display.innerHTML = '';
      if (!normalized.length) {
        const empty = document.createElement('span');
        empty.className = 'text-muted';
        empty.textContent = 'No work experience records listed';
        display.appendChild(empty);
      } else {
        normalized.forEach(function(entry, idx) {
          const wrapper = document.createElement('div');
          wrapper.className = 'work-experience-entry border rounded p-3';
          if (idx !== normalized.length - 1) wrapper.classList.add('mb-3');
          const row = document.createElement('div');
          row.className = 'row g-3';
          WORK_EXPERIENCE_FIELD_ORDER.forEach(function(field) {
            const config = WORK_EXPERIENCE_FIELD_CONFIG[field];
            if (!config) return;
            const col = document.createElement('div');
            col.className = config.col;
            const label = document.createElement('div');
            label.className = 'text-muted small';
            label.textContent = config.label;
            const valueEl = document.createElement('div');
            valueEl.className = 'fw-semibold';
            valueEl.textContent = entry[field] || '';
            col.appendChild(label);
            col.appendChild(valueEl);
            row.appendChild(col);
          });
          wrapper.appendChild(row);
          display.appendChild(wrapper);
        });
      }
    }
    section.setAttribute('data-we-records', JSON.stringify(normalized));
  }

  function addWorkExperienceRow(wrapper, record, index, focus) {
    const entryContainer = document.createElement('div');
    entryContainer.className = 'work-experience-entry border rounded p-3';
    if (wrapper.querySelector('[data-we-entry]')) {
      entryContainer.classList.add('mt-2');
    }
    entryContainer.setAttribute('data-we-entry', '1');

    const row = document.createElement('div');
    row.className = 'row g-3';
    entryContainer.appendChild(row);

    WORK_EXPERIENCE_FIELD_ORDER.forEach(function(field) {
      const config = WORK_EXPERIENCE_FIELD_CONFIG[field];
      if (!config) return;
      const col = document.createElement('div');
      col.className = config.col;
      const label = document.createElement('div');
      label.className = 'text-muted small';
      label.textContent = config.label;
      const valueWrap = document.createElement('div');
      const value = (record && record[field]) ? String(record[field]).trim() : '';
      valueWrap.setAttribute('data-original-text', value);
      const inputDesc = { type: 'text' };
      if (config.placeholder) inputDesc.placeholder = config.placeholder;
      const input = createInputControl(inputDesc, value);
      input.classList.add('work-experience-input');
      input.setAttribute('data-we-field', field);
      input.setAttribute('data-we-index', typeof index === 'number' ? String(index) : '');
      valueWrap.appendChild(input);
      col.appendChild(label);
      col.appendChild(valueWrap);
      row.appendChild(col);
    });

    const actionsCol = document.createElement('div');
    actionsCol.className = 'col-12 d-flex justify-content-end';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm we-remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
    removeBtn.addEventListener('click', function() {
      const parent = entryContainer.parentElement;
      if (parent) {
        parent.removeChild(entryContainer);
        if (!parent.querySelector('[data-we-entry]')) {
          addWorkExperienceRow(parent, {}, 0, true);
        }
        renumberWorkExperienceRows(parent);
      }
    });
    actionsCol.appendChild(removeBtn);
    row.appendChild(actionsCol);

    wrapper.appendChild(entryContainer);

    if (focus) {
      const firstInput = entryContainer.querySelector('.work-experience-input');
      if (firstInput) {
        try { firstInput.focus(); } catch (e) {}
      }
    }
  }

  function renumberWorkExperienceRows(wrapper) {
    const rows = Array.from(wrapper.querySelectorAll('[data-we-entry]'));
    rows.forEach(function(row, idx) {
      row.setAttribute('data-we-index', String(idx));
      const removeBtn = row.querySelector('.we-remove-btn');
      if (removeBtn) {
        if (rows.length <= 1) {
          removeBtn.classList.add('d-none');
        } else {
          removeBtn.classList.remove('d-none');
        }
      }
      const inputs = row.querySelectorAll('.work-experience-input');
      inputs.forEach(function(input) {
        input.setAttribute('data-we-index', String(idx));
      });
    });
  }

  function setupWorkExperienceEditor(section) {
    if (!section || section.getAttribute('data-we-editing') === '1') return;
    const records = parseWorkExperienceRecordsAttr(section);
    const workingRecords = records.length ? records : [{}];
    section.setAttribute('data-we-editing', '1');
    section.setAttribute('data-we-original-json', JSON.stringify(records));

    const display = section.querySelector('[data-we-display]');
    if (display) display.style.display = 'none';

    const existingWrapper = section.querySelector('[data-we-edit-wrapper]');
    if (existingWrapper) existingWrapper.remove();
    const existingControls = section.querySelector('[data-we-controls]');
    if (existingControls) existingControls.remove();

    const editWrapper = document.createElement('div');
    editWrapper.className = 'work-experience-edit-wrapper d-flex flex-column';
    editWrapper.setAttribute('data-we-edit-wrapper', '1');
    section.appendChild(editWrapper);

    workingRecords.forEach(function(record, index) {
      addWorkExperienceRow(editWrapper, record, index, false);
    });
    renumberWorkExperienceRows(editWrapper);

    const controls = document.createElement('div');
    controls.className = 'mt-2';
    controls.setAttribute('data-we-controls', '1');
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-outline-secondary btn-sm';
    addBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Work Experience';
    addBtn.addEventListener('click', function() {
      const currentRows = editWrapper.querySelectorAll('[data-we-entry]').length;
      addWorkExperienceRow(editWrapper, {}, currentRows, true);
      renumberWorkExperienceRows(editWrapper);
    });
    controls.appendChild(addBtn);
    section.appendChild(controls);
  }

  function getWorkExperienceEntries(section) {
    if (!section) return [];
    const editWrapper = section.querySelector('[data-we-edit-wrapper]');
    if (!editWrapper) {
      return parseWorkExperienceRecordsAttr(section);
    }
    const rows = Array.from(editWrapper.querySelectorAll('[data-we-entry]'));
    const entries = rows.map(function(row) {
      const entry = {};
      WORK_EXPERIENCE_FIELD_ORDER.forEach(function(field) {
        const input = row.querySelector('.work-experience-input[data-we-field="' + field + '"]');
        entry[field] = input ? (input.value || '').trim() : '';
      });
      return entry;
    });
    return normalizeWorkExperienceEntries(entries);
  }

  function collectWorkExperienceData(modal) {
    if (!modal) return null;
    const section = modal.querySelector('[data-we-section]');
    if (!section) return null;
    if (!section.querySelector('[data-we-edit-wrapper]')) return null;
    return getWorkExperienceEntries(section);
  }

  function exitWorkExperienceSection(section, updatedMap) {
    if (!section) return;
    let records = [];
    if (updatedMap && Object.prototype.hasOwnProperty.call(updatedMap, 'work_experience_json')) {
      const raw = updatedMap['work_experience_json'];
      let parsed = [];
      if (typeof raw === 'string') {
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          parsed = [];
        }
      } else if (Array.isArray(raw)) {
        parsed = raw;
      } else if (raw && typeof raw === 'object') {
        parsed = [raw];
      }
      records = normalizeWorkExperienceEntries(parsed);
    } else {
      records = parseWorkExperienceRecordsAttr(section);
    }
    const editWrapper = section.querySelector('[data-we-edit-wrapper]');
    if (editWrapper) editWrapper.remove();
    const controls = section.querySelector('[data-we-controls]');
    if (controls) controls.remove();
    section.removeAttribute('data-we-editing');
    section.removeAttribute('data-we-original-json');
    const display = section.querySelector('[data-we-display]');
    if (display) display.style.display = '';
    renderWorkExperienceDisplay(section, records);
  }

  function normalizeVoluntaryWorkEntries(entries) {
    if (!Array.isArray(entries)) return [];
    const normalized = [];
    entries.forEach(function(entry) {
      if (!entry || typeof entry !== 'object') return;
      const normalizedEntry = {};
      let hasValue = false;
      VOLUNTARY_WORK_FIELD_ORDER.forEach(function(field) {
        let value = entry[field];
        if (typeof value === 'number') value = String(value);
        if (typeof value !== 'string') value = value ? String(value) : '';
        value = value.trim();
        if (value) hasValue = true;
        normalizedEntry[field] = value;
      });
      if (hasValue) normalized.push(normalizedEntry);
    });
    return normalized;
  }

  function parseVoluntaryWorkRecordsAttr(section) {
    if (!section) return [];
    const raw = section.getAttribute('data-vw-records');
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return normalizeVoluntaryWorkEntries(parsed);
    } catch (e) {
      return [];
    }
  }

  function renderVoluntaryWorkDisplay(section, entries) {
    if (!section) return;
    const normalized = normalizeVoluntaryWorkEntries(entries);
    const display = section.querySelector('[data-vw-display]');
    if (display) {
      display.innerHTML = '';
      if (!normalized.length) {
        const empty = document.createElement('span');
        empty.className = 'text-muted';
        empty.textContent = 'No voluntary work records listed';
        display.appendChild(empty);
      } else {
        normalized.forEach(function(entry, idx) {
          const wrapper = document.createElement('div');
          wrapper.className = 'voluntary-work-entry border rounded p-3';
          if (idx !== normalized.length - 1) wrapper.classList.add('mb-3');
          const row = document.createElement('div');
          row.className = 'row g-3';
          VOLUNTARY_WORK_FIELD_ORDER.forEach(function(field) {
            const config = VOLUNTARY_WORK_FIELD_CONFIG[field];
            if (!config) return;
            const col = document.createElement('div');
            col.className = config.col;
            const label = document.createElement('div');
            label.className = 'text-muted small';
            label.textContent = config.label;
            const valueEl = document.createElement('div');
            valueEl.className = 'fw-semibold';
            valueEl.textContent = entry[field] || '';
            col.appendChild(label);
            col.appendChild(valueEl);
            row.appendChild(col);
          });
          wrapper.appendChild(row);
          display.appendChild(wrapper);
        });
      }
    }
    section.setAttribute('data-vw-records', JSON.stringify(normalized));
  }

  function addVoluntaryWorkRow(wrapper, record, index, focus) {
    const entryContainer = document.createElement('div');
    entryContainer.className = 'voluntary-work-entry border rounded p-3';
    if (wrapper.querySelector('[data-vw-entry]')) {
      entryContainer.classList.add('mt-2');
    }
    entryContainer.setAttribute('data-vw-entry', '1');

    const row = document.createElement('div');
    row.className = 'row g-3';
    entryContainer.appendChild(row);

    VOLUNTARY_WORK_FIELD_ORDER.forEach(function(field) {
      const config = VOLUNTARY_WORK_FIELD_CONFIG[field];
      if (!config) return;
      const col = document.createElement('div');
      col.className = config.col;
      const label = document.createElement('div');
      label.className = 'text-muted small';
      label.textContent = config.label;
      const valueWrap = document.createElement('div');
      const value = (record && record[field]) ? String(record[field]).trim() : '';
      valueWrap.setAttribute('data-original-text', value);
      const inputDesc = { type: 'text' };
      if (config.placeholder) inputDesc.placeholder = config.placeholder;
      const input = createInputControl(inputDesc, value);
      input.classList.add('voluntary-work-input');
      input.setAttribute('data-vw-field', field);
      input.setAttribute('data-vw-index', typeof index === 'number' ? String(index) : '');
      valueWrap.appendChild(input);
      col.appendChild(label);
      col.appendChild(valueWrap);
      row.appendChild(col);
    });

    const actionsCol = document.createElement('div');
    actionsCol.className = 'col-12 d-flex justify-content-end';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm vw-remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
    removeBtn.addEventListener('click', function() {
      const parent = entryContainer.parentElement;
      if (parent) {
        parent.removeChild(entryContainer);
        if (!parent.querySelector('[data-vw-entry]')) {
          addVoluntaryWorkRow(parent, {}, 0, true);
        }
        renumberVoluntaryWorkRows(parent);
      }
    });
    actionsCol.appendChild(removeBtn);
    row.appendChild(actionsCol);

    wrapper.appendChild(entryContainer);

    if (focus) {
      const firstInput = entryContainer.querySelector('.voluntary-work-input');
      if (firstInput) {
        try { firstInput.focus(); } catch (e) {}
      }
    }
  }

  function renumberVoluntaryWorkRows(wrapper) {
    const rows = Array.from(wrapper.querySelectorAll('[data-vw-entry]'));
    rows.forEach(function(row, idx) {
      row.setAttribute('data-vw-index', String(idx));
      const removeBtn = row.querySelector('.vw-remove-btn');
      if (removeBtn) {
        if (rows.length <= 1) {
          removeBtn.classList.add('d-none');
        } else {
          removeBtn.classList.remove('d-none');
        }
      }
      const inputs = row.querySelectorAll('.voluntary-work-input');
      inputs.forEach(function(input) {
        input.setAttribute('data-vw-index', String(idx));
      });
    });
  }

  function setupVoluntaryWorkEditor(section) {
    if (!section || section.getAttribute('data-vw-editing') === '1') return;
    const records = parseVoluntaryWorkRecordsAttr(section);
    const workingRecords = records.length ? records : [{}];
    section.setAttribute('data-vw-editing', '1');
    section.setAttribute('data-vw-original-json', JSON.stringify(records));

    const display = section.querySelector('[data-vw-display]');
    if (display) display.style.display = 'none';

    const existingWrapper = section.querySelector('[data-vw-edit-wrapper]');
    if (existingWrapper) existingWrapper.remove();
    const existingControls = section.querySelector('[data-vw-controls]');
    if (existingControls) existingControls.remove();

    const editWrapper = document.createElement('div');
    editWrapper.className = 'voluntary-work-edit-wrapper d-flex flex-column';
    editWrapper.setAttribute('data-vw-edit-wrapper', '1');
    section.appendChild(editWrapper);

    workingRecords.forEach(function(record, index) {
      addVoluntaryWorkRow(editWrapper, record, index, false);
    });
    renumberVoluntaryWorkRows(editWrapper);

    const controls = document.createElement('div');
    controls.className = 'mt-2';
    controls.setAttribute('data-vw-controls', '1');
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-outline-secondary btn-sm';
    addBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Voluntary Work';
    addBtn.addEventListener('click', function() {
      const currentRows = editWrapper.querySelectorAll('[data-vw-entry]').length;
      addVoluntaryWorkRow(editWrapper, {}, currentRows, true);
      renumberVoluntaryWorkRows(editWrapper);
    });
    controls.appendChild(addBtn);
    section.appendChild(controls);
  }

  function getVoluntaryWorkEntries(section) {
    if (!section) return [];
    const editWrapper = section.querySelector('[data-vw-edit-wrapper]');
    if (!editWrapper) {
      return parseVoluntaryWorkRecordsAttr(section);
    }
    const rows = Array.from(editWrapper.querySelectorAll('[data-vw-entry]'));
    const entries = rows.map(function(row) {
      const entry = {};
      VOLUNTARY_WORK_FIELD_ORDER.forEach(function(field) {
        const input = row.querySelector('.voluntary-work-input[data-vw-field="' + field + '"]');
        entry[field] = input ? (input.value || '').trim() : '';
      });
      return entry;
    });
    return normalizeVoluntaryWorkEntries(entries);
  }

  function collectVoluntaryWorkData(modal) {
    if (!modal) return null;
    const section = modal.querySelector('[data-vw-section]');
    if (!section) return null;
    if (!section.querySelector('[data-vw-edit-wrapper]')) return null;
    return getVoluntaryWorkEntries(section);
  }

  function exitVoluntaryWorkSection(section, updatedMap) {
    if (!section) return;
    let records = [];
    if (updatedMap && Object.prototype.hasOwnProperty.call(updatedMap, 'voluntary_work_json')) {
      const raw = updatedMap['voluntary_work_json'];
      let parsed = [];
      if (typeof raw === 'string') {
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          parsed = [];
        }
      } else if (Array.isArray(raw)) {
        parsed = raw;
      } else if (raw && typeof raw === 'object') {
        parsed = [raw];
      }
      records = normalizeVoluntaryWorkEntries(parsed);
    } else {
      records = parseVoluntaryWorkRecordsAttr(section);
    }
    const editWrapper = section.querySelector('[data-vw-edit-wrapper]');
    if (editWrapper) editWrapper.remove();
    const controls = section.querySelector('[data-vw-controls]');
    if (controls) controls.remove();
    section.removeAttribute('data-vw-editing');
    section.removeAttribute('data-vw-original-json');
    const display = section.querySelector('[data-vw-display]');
    if (display) display.style.display = '';
    renderVoluntaryWorkDisplay(section, records);
  }

  function normalizeLearningDevEntries(entries) {
    if (!Array.isArray(entries)) return [];
    const normalized = [];
    entries.forEach(function(entry) {
      if (!entry || typeof entry !== 'object') return;
      const normalizedEntry = {};
      let hasValue = false;
      LEARNING_DEV_FIELD_ORDER.forEach(function(field) {
        let value = entry[field];
        if (typeof value === 'number') value = String(value);
        if (typeof value !== 'string') value = value ? String(value) : '';
        value = value.trim();
        if (value) hasValue = true;
        normalizedEntry[field] = value;
      });
      if (hasValue) normalized.push(normalizedEntry);
    });
    return normalized;
  }

  function parseLearningDevRecordsAttr(section) {
    if (!section) return [];
    const raw = section.getAttribute('data-ld-records');
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return normalizeLearningDevEntries(parsed);
    } catch (e) {
      return [];
    }
  }

  function renderLearningDevDisplay(section, entries) {
    if (!section) return;
    const normalized = normalizeLearningDevEntries(entries);
    const display = section.querySelector('[data-ld-display]');
    if (display) {
      display.innerHTML = '';
      if (!normalized.length) {
        const empty = document.createElement('span');
        empty.className = 'text-muted';
        empty.textContent = 'No learning & development records listed';
        display.appendChild(empty);
      } else {
        normalized.forEach(function(entry, idx) {
          const wrapper = document.createElement('div');
          wrapper.className = 'learning-dev-entry border rounded p-3';
          if (idx !== normalized.length - 1) wrapper.classList.add('mb-3');
          const row = document.createElement('div');
          row.className = 'row g-3';
          LEARNING_DEV_FIELD_ORDER.forEach(function(field) {
            const config = LEARNING_DEV_FIELD_CONFIG[field];
            if (!config) return;
            const col = document.createElement('div');
            col.className = config.col;
            const label = document.createElement('div');
            label.className = 'text-muted small';
            label.textContent = config.label;
            const valueEl = document.createElement('div');
            valueEl.className = 'fw-semibold';
            valueEl.textContent = entry[field] || '';
            col.appendChild(label);
            col.appendChild(valueEl);
            row.appendChild(col);
          });
          wrapper.appendChild(row);
          display.appendChild(wrapper);
        });
      }
    }
    section.setAttribute('data-ld-records', JSON.stringify(normalized));
  }

  function addLearningDevRow(wrapper, record, index, focus) {
    const entryContainer = document.createElement('div');
    entryContainer.className = 'learning-dev-entry border rounded p-3';
    if (wrapper.querySelector('[data-ld-entry]')) {
      entryContainer.classList.add('mt-2');
    }
    entryContainer.setAttribute('data-ld-entry', '1');

    const row = document.createElement('div');
    row.className = 'row g-3';
    entryContainer.appendChild(row);

    LEARNING_DEV_FIELD_ORDER.forEach(function(field) {
      const config = LEARNING_DEV_FIELD_CONFIG[field];
      if (!config) return;
      const col = document.createElement('div');
      col.className = config.col;
      const label = document.createElement('div');
      label.className = 'text-muted small';
      label.textContent = config.label;
      const valueWrap = document.createElement('div');
      const value = (record && record[field]) ? String(record[field]).trim() : '';
      valueWrap.setAttribute('data-original-text', value);
      const inputDesc = { type: 'text' };
      if (config.placeholder) inputDesc.placeholder = config.placeholder;
      const input = createInputControl(inputDesc, value);
      input.classList.add('learning-dev-input');
      input.setAttribute('data-ld-field', field);
      input.setAttribute('data-ld-index', typeof index === 'number' ? String(index) : '');
      valueWrap.appendChild(input);
      col.appendChild(label);
      col.appendChild(valueWrap);
      row.appendChild(col);
    });

    const actionsCol = document.createElement('div');
    actionsCol.className = 'col-12 d-flex justify-content-end';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-outline-danger btn-sm ld-remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
    removeBtn.addEventListener('click', function() {
      const parent = entryContainer.parentElement;
      if (parent) {
        parent.removeChild(entryContainer);
        if (!parent.querySelector('[data-ld-entry]')) {
          addLearningDevRow(parent, {}, 0, true);
        }
        renumberLearningDevRows(parent);
      }
    });
    actionsCol.appendChild(removeBtn);
    row.appendChild(actionsCol);

    wrapper.appendChild(entryContainer);

    if (focus) {
      const firstInput = entryContainer.querySelector('.learning-dev-input');
      if (firstInput) {
        try { firstInput.focus(); } catch (e) {}
      }
    }
  }

  function renumberLearningDevRows(wrapper) {
    const rows = Array.from(wrapper.querySelectorAll('[data-ld-entry]'));
    rows.forEach(function(row, idx) {
      row.setAttribute('data-ld-index', String(idx));
      const removeBtn = row.querySelector('.ld-remove-btn');
      if (removeBtn) {
        if (rows.length <= 1) {
          removeBtn.classList.add('d-none');
        } else {
          removeBtn.classList.remove('d-none');
        }
      }
      const inputs = row.querySelectorAll('.learning-dev-input');
      inputs.forEach(function(input) {
        input.setAttribute('data-ld-index', String(idx));
      });
    });
  }

  function setupLearningDevEditor(section) {
    if (!section || section.getAttribute('data-ld-editing') === '1') return;
    const records = parseLearningDevRecordsAttr(section);
    const workingRecords = records.length ? records : [{}];
    section.setAttribute('data-ld-editing', '1');
    section.setAttribute('data-ld-original-json', JSON.stringify(records));

    const display = section.querySelector('[data-ld-display]');
    if (display) display.style.display = 'none';

    const existingWrapper = section.querySelector('[data-ld-edit-wrapper]');
    if (existingWrapper) existingWrapper.remove();
    const existingControls = section.querySelector('[data-ld-controls]');
    if (existingControls) existingControls.remove();

    const editWrapper = document.createElement('div');
    editWrapper.className = 'learning-dev-edit-wrapper d-flex flex-column';
    editWrapper.setAttribute('data-ld-edit-wrapper', '1');
    section.appendChild(editWrapper);

    workingRecords.forEach(function(record, index) {
      addLearningDevRow(editWrapper, record, index, false);
    });
    renumberLearningDevRows(editWrapper);

    const controls = document.createElement('div');
    controls.className = 'mt-2';
    controls.setAttribute('data-ld-controls', '1');
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'btn btn-outline-secondary btn-sm';
    addBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add L&D Entry';
    addBtn.addEventListener('click', function() {
      const currentRows = editWrapper.querySelectorAll('[data-ld-entry]').length;
      addLearningDevRow(editWrapper, {}, currentRows, true);
      renumberLearningDevRows(editWrapper);
    });
    controls.appendChild(addBtn);
    section.appendChild(controls);
  }

  function getLearningDevEntries(section) {
    if (!section) return [];
    const editWrapper = section.querySelector('[data-ld-edit-wrapper]');
    if (!editWrapper) {
      return parseLearningDevRecordsAttr(section);
    }
    const rows = Array.from(editWrapper.querySelectorAll('[data-ld-entry]'));
    const entries = rows.map(function(row) {
      const entry = {};
      LEARNING_DEV_FIELD_ORDER.forEach(function(field) {
        const input = row.querySelector('.learning-dev-input[data-ld-field="' + field + '"]');
        entry[field] = input ? (input.value || '').trim() : '';
      });
      return entry;
    });
    return normalizeLearningDevEntries(entries);
  }

  function collectLearningDevData(modal) {
    if (!modal) return null;
    const section = modal.querySelector('[data-ld-section]');
    if (!section) return null;
    if (!section.querySelector('[data-ld-edit-wrapper]')) return null;
    return getLearningDevEntries(section);
  }

  function exitLearningDevSection(section, updatedMap) {
    if (!section) return;
    let records = [];
    if (updatedMap && Object.prototype.hasOwnProperty.call(updatedMap, 'learning_dev_json')) {
      const raw = updatedMap['learning_dev_json'];
      let parsed = [];
      if (typeof raw === 'string') {
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          parsed = [];
        }
      } else if (Array.isArray(raw)) {
        parsed = raw;
      } else if (raw && typeof raw === 'object') {
        parsed = [raw];
      }
      records = normalizeLearningDevEntries(parsed);
    } else {
      records = parseLearningDevRecordsAttr(section);
    }
    const editWrapper = section.querySelector('[data-ld-edit-wrapper]');
    if (editWrapper) editWrapper.remove();
    const controls = section.querySelector('[data-ld-controls]');
    if (controls) controls.remove();
    section.removeAttribute('data-ld-editing');
    section.removeAttribute('data-ld-original-json');
    const display = section.querySelector('[data-ld-display]');
    if (display) display.style.display = '';
    renderLearningDevDisplay(section, records);
  }

  function exitEducationSections(ebCardBody, updatedMap) {
    if (!ebCardBody) return;
    const sections = ebCardBody.querySelectorAll('[data-education-section]');
    sections.forEach(function(section) {
      const levelKey = section.getAttribute('data-education-section');
      const prefix = EDUCATION_PREFIX_MAP[levelKey];
      const jsonField = prefix ? (prefix + '_records_json') : null;
      let records = [];
      if (updatedMap && jsonField && Object.prototype.hasOwnProperty.call(updatedMap, jsonField)) {
        const raw = updatedMap[jsonField];
        let rawStr = '';
        if (Array.isArray(raw)) rawStr = JSON.stringify(raw);
        else if (typeof raw === 'string') rawStr = raw;
        else rawStr = JSON.stringify(raw || []);
        try {
          records = JSON.parse(rawStr);
        } catch (e) {
          records = [];
        }
      } else if (section.hasAttribute('data-original-json')) {
        try {
          records = JSON.parse(section.getAttribute('data-original-json') || '[]');
        } catch (e) {
          records = [];
        }
      } else {
        records = parseEducationRecordsAttr(section);
      }
      records = normalizeEducationEntries(records);
      const editWrapper = section.querySelector('[data-education-edit-wrapper]');
      if (editWrapper) editWrapper.remove();
      const controls = section.querySelector('[data-education-controls]');
      if (controls) controls.remove();
      section.removeAttribute('data-original-json');
      section.removeAttribute('data-editing');
      const display = section.querySelector('[data-education-display]');
      if (display) display.style.display = '';
      renderEducationDisplay(section, records);
    });
  }

  function enterEdit(modal) {
    if (!modal) return;
    const employeeId = modal.getAttribute('id').replace('viewEmployeeModal-', '');
    const piTab = modal.querySelector('#tab-pi-' + employeeId);
    const fbTab = modal.querySelector('#tab-fb-' + employeeId);
    const ebTab = modal.querySelector('#tab-eb-' + employeeId);
    const weTab = modal.querySelector('#tab-we-' + employeeId);
    const vwTab = modal.querySelector('#tab-vw-' + employeeId);
    const ldTab = modal.querySelector('#tab-ld-' + employeeId);
    const cseTab = modal.querySelector('#tab-cse-' + employeeId);
    const piCardBody = piTab ? piTab.querySelector('.card-body') : null;
    const fbCardBody = fbTab ? fbTab.querySelector('.card-body') : null;
    const ebCardBody = ebTab ? ebTab.querySelector('.card-body') : null;
    const weCardBody = weTab ? weTab.querySelector('.card-body') : null;
    const vwCardBody = vwTab ? vwTab.querySelector('.card-body') : null;
    const ldCardBody = ldTab ? ldTab.querySelector('.card-body') : null;
    const cseCardBody = cseTab ? cseTab.querySelector('.card-body') : null;
    if (!piCardBody && !fbCardBody && !ebCardBody && !weCardBody && !vwCardBody && !ldCardBody && !cseCardBody) return;

    // Helper to attach editor to label/value pair
    function attachEditor(valueEl, desc, currentText) {
      if (valueEl.querySelector('.pi-input')) return;
      valueEl.setAttribute('data-original-text', currentText);
      valueEl.innerHTML = '';
      const input = createInputControl(desc, currentText);
      input.setAttribute('data-key', desc.key);
      valueEl.appendChild(input);
      return input;
    }

    if (piCardBody) {
      // Personal Information grid (top section) - labels as div.text-muted.small
      const personalCols = piCardBody.querySelectorAll('.row.g-3 > [class^="col-"]');
      personalCols.forEach(function(col) {
        const labelEl = col.querySelector('.text-muted.small');
        const valueEl = col.querySelector('.fw-semibold');
        if (!labelEl || !valueEl) return;
        const label = (labelEl.textContent || '').trim();
        const desc = personalFieldMap[label];
        if (!desc) return;
        const currentText = (valueEl.textContent || '').trim();
        attachEditor(valueEl, desc, currentText);
      });

      // Residential and Permanent Address sections
      const sectionHeaders = piCardBody.querySelectorAll('.text-muted.small.mb-1');
      sectionHeaders.forEach(function(hdr) {
        const sectionTitle = (hdr.textContent || '').trim();
        const isRes = sectionTitle === 'Residential Address';
        const isPerm = sectionTitle === 'Permanent Address';
        if (!isRes && !isPerm) return;
        const row = hdr.parentElement && hdr.parentElement.querySelector('.row.g-2');
        if (!row) return;
        const cols = row.querySelectorAll('[class^="col-"]');
        cols.forEach(function(col) {
          const labelEl = col.querySelector('small.text-muted');
          const valueEl = col.querySelector('.fw-semibold');
          if (!labelEl || !valueEl) return;
          const label = (labelEl.textContent || '').trim();
          const suffix = addressLabelToSuffix[label];
          if (!suffix) return;
          const key = (isRes ? 'res_' : 'perm_') + suffix;
          const desc = { key, type: 'text' };
          const currentText = (valueEl.textContent || '').trim();
          attachEditor(valueEl, desc, currentText);
        });
      });

      // Employment Details (Auto-filled) - a row.g-3 after its header
      const empHeader = Array.from(piCardBody.querySelectorAll('h6.text-uppercase.text-muted.small'))
        .find(h => (h.textContent || '').includes('Employment Details'));
      if (empHeader) {
        const empRow = empHeader.parentElement && empHeader.parentElement.querySelector('.row.g-3');
        if (empRow) {
          const cols = empRow.querySelectorAll('[class^="col-"]');
          cols.forEach(function(col) {
            const labelEl = col.querySelector('.text-muted.small');
            const valueEl = col.querySelector('.fw-semibold, span.badge, div.fw-semibold');
            if (!labelEl || !valueEl) return;
            const lbl = (labelEl.textContent || '').trim();
            const map = employmentFieldMap[lbl];
            if (!map) return;
            const currentText = (valueEl.textContent || '').trim();
            const input = attachEditor(col.querySelector('.fw-semibold') || valueEl, map, currentText);

            // Biometric duplicate verification inline
            if (map.key === 'bio_number' && input) {
              const excludeId = parseInt(employeeId, 10) || null;
              const runCheck = debounce(async function() {
                const val = (input.value || '').trim();
                if (!val) { input.classList.remove('is-invalid'); return; }
                try {
                  const data = await checkBio(val, excludeId);
                  if (data && data.valid) {
                    input.classList.remove('is-invalid');
                    input.removeAttribute('title');
                  } else {
                    input.classList.add('is-invalid');
                    input.setAttribute('title', (data && data.message) ? data.message : 'Biometric number is already taken');
                  }
                } catch {
                  input.classList.remove('is-invalid');
                  input.removeAttribute('title');
                }
              }, 400);
              input.addEventListener('input', () => { input.classList.remove('is-invalid'); runCheck(); });
            }

            // Replace badges (Position/Status) with selects in DOM location showing text
            if ((map.key === 'position' || map.key === 'status') && input && input.tagName === 'SELECT') {
              // Nothing extra needed; attachEditor already set select
            }
          });
        }
      }
    }

    if (fbCardBody) {
      const familyFields = fbCardBody.querySelectorAll('.fw-semibold[data-family-key]');
      familyFields.forEach(function(valueEl) {
        const mapKey = valueEl.getAttribute('data-family-key');
        if (!mapKey) return;
        const desc = familyFieldMap[mapKey];
        if (!desc) return;
        if (desc.type === 'children') {
          setupChildrenEditor(valueEl);
          return;
        }
        const currentText = (valueEl.textContent || '').trim();
        attachEditor(valueEl, desc, currentText);
      });
    }

    if (ebCardBody) {
      enterEducationSections(ebCardBody);
    }

    if (weCardBody) {
      const weSection = weCardBody.querySelector('[data-we-section]');
      if (weSection) {
        setupWorkExperienceEditor(weSection);
      }
    }

    if (vwCardBody) {
      const vwSection = vwCardBody.querySelector('[data-vw-section]');
      if (vwSection) {
        setupVoluntaryWorkEditor(vwSection);
      }
    }

    if (ldCardBody) {
      const ldSection = ldCardBody.querySelector('[data-ld-section]');
      if (ldSection) {
        setupLearningDevEditor(ldSection);
      }
    }

    if (cseCardBody) {
      const cseSection = cseCardBody.querySelector('[data-cse-section]');
      if (cseSection) {
        setupCivilServiceEditor(cseSection);
      }
    }

    modal.setAttribute('data-editing', '1');
    const btn = modal.querySelector('[data-action="toggle-edit"]');
    if (btn) {
      btn.innerHTML = '<i class="fas fa-save me-1"></i> Save';
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-success');
    }
  }

  function exitEdit(modal, updatedMap) {
    if (!modal) return;
    const employeeId = modal.getAttribute('id').replace('viewEmployeeModal-', '');
    const piTab = modal.querySelector('#tab-pi-' + employeeId);
    const fbTab = modal.querySelector('#tab-fb-' + employeeId);
    const ebTab = modal.querySelector('#tab-eb-' + employeeId);
    const weTab = modal.querySelector('#tab-we-' + employeeId);
    const vwTab = modal.querySelector('#tab-vw-' + employeeId);
    const ldTab = modal.querySelector('#tab-ld-' + employeeId);
    const cseTab = modal.querySelector('#tab-cse-' + employeeId);
    const piCardBody = piTab ? piTab.querySelector('.card-body') : null;
    const fbCardBody = fbTab ? fbTab.querySelector('.card-body') : null;
    const ebCardBody = ebTab ? ebTab.querySelector('.card-body') : null;
    const weCardBody = weTab ? weTab.querySelector('.card-body') : null;
    const vwCardBody = vwTab ? vwTab.querySelector('.card-body') : null;
    const ldCardBody = ldTab ? ldTab.querySelector('.card-body') : null;
    const cseCardBody = cseTab ? cseTab.querySelector('.card-body') : null;
    if (!piCardBody && !fbCardBody && !ebCardBody && !weCardBody && !vwCardBody && !ldCardBody && !cseCardBody) return;

    function restoreValue(valueEl, mapKey) {
      if (!valueEl) return;
      if (mapKey === 'children_info') {
        let newValue = '';
        if (updatedMap && (mapKey in updatedMap)) {
          newValue = updatedMap[mapKey] || '';
        } else {
          newValue = valueEl.getAttribute('data-original-text') || '';
        }
        renderChildrenDisplay(valueEl, newValue);
        return;
      }
      const input = valueEl.querySelector('.pi-input');
      let newValue = (input && 'value' in input) ? input.value : (valueEl.getAttribute('data-original-text') || '');
      if (updatedMap && mapKey && (mapKey in updatedMap)) {
        newValue = updatedMap[mapKey] || '';
      }
      valueEl.innerHTML = '';
      valueEl.textContent = newValue;
      valueEl.removeAttribute('data-original-text');
    }

    if (piCardBody) {
      // Personal top grid
      const personalCols = piCardBody.querySelectorAll('.row.g-3 > [class^="col-"]');
      personalCols.forEach(function(col) {
        const labelEl = col.querySelector('.text-muted.small');
        const valueEl = col.querySelector('.fw-semibold');
        if (!labelEl || !valueEl) return;
        const label = (labelEl.textContent || '').trim();
        const desc = personalFieldMap[label];
        if (!desc) return;
        restoreValue(valueEl, desc.key);
      });

      // Residential / Permanent
      const sectionHeaders = piCardBody.querySelectorAll('.text-muted.small.mb-1');
      sectionHeaders.forEach(function(hdr) {
        const sectionTitle = (hdr.textContent || '').trim();
        const isRes = sectionTitle === 'Residential Address';
        const isPerm = sectionTitle === 'Permanent Address';
        if (!isRes && !isPerm) return;
        const row = hdr.parentElement && hdr.parentElement.querySelector('.row.g-2');
        if (!row) return;
        const cols = row.querySelectorAll('[class^="col-"]');
        cols.forEach(function(col) {
          const labelEl = col.querySelector('small.text-muted');
          const valueEl = col.querySelector('.fw-semibold');
          if (!labelEl || !valueEl) return;
          const label = (labelEl.textContent || '').trim();
          const suffix = addressLabelToSuffix[label];
          if (!suffix) return;
          const key = (isRes ? 'res_' : 'perm_') + suffix;
          restoreValue(valueEl, key);
        });
      });

      // Employment
      const empHeader = Array.from(piCardBody.querySelectorAll('h6.text-uppercase.text-muted.small'))
        .find(h => (h.textContent || '').includes('Employment Details'));
      if (empHeader) {
        const empRow = empHeader.parentElement && empHeader.parentElement.querySelector('.row.g-3');
        if (empRow) {
          const cols = empRow.querySelectorAll('[class^="col-"]');
          cols.forEach(function(col) {
            const labelEl = col.querySelector('.text-muted.small');
            const valueEl = col.querySelector('.fw-semibold') || col.querySelector('div.fw-semibold');
            if (!labelEl || !valueEl) return;
            const lbl = (labelEl.textContent || '').trim();
            const map = employmentFieldMap[lbl];
            if (!map) return;
            restoreValue(valueEl, map.key);
          });
        }
      }
    }

    if (fbCardBody) {
      const familyFields = fbCardBody.querySelectorAll('.fw-semibold[data-family-key]');
      familyFields.forEach(function(valueEl) {
        const mapKey = valueEl.getAttribute('data-family-key');
        if (!mapKey) return;
        const desc = familyFieldMap[mapKey];
        if (!desc) return;
        restoreValue(valueEl, desc.key);
      });
    }

    if (ebCardBody) {
      exitEducationSections(ebCardBody, updatedMap);
    }

    if (weCardBody) {
      const weSection = weCardBody.querySelector('[data-we-section]');
      exitWorkExperienceSection(weSection, updatedMap);
    }

    if (vwCardBody) {
      const vwSection = vwCardBody.querySelector('[data-vw-section]');
      exitVoluntaryWorkSection(vwSection, updatedMap);
    }

    if (ldCardBody) {
      const ldSection = ldCardBody.querySelector('[data-ld-section]');
      exitLearningDevSection(ldSection, updatedMap);
    }

    if (cseCardBody) {
      const cseSection = cseCardBody.querySelector('[data-cse-section]');
      exitCivilServiceSection(cseSection, updatedMap);
    }

    modal.removeAttribute('data-editing');
    const btn = modal.querySelector('[data-action="toggle-edit"]');
    if (btn) {
      btn.innerHTML = '<i class="fas fa-pen-to-square me-1"></i> Edit Details';
      btn.classList.remove('btn-success');
      btn.classList.add('btn-primary');
    }
  }

  function requestSave(modal) {
    const employeeId = modal.getAttribute('id').replace('viewEmployeeModal-', '');
    const inputs = modal.querySelectorAll('.pi-input');
    if (!inputs.length) {
      exitEdit(modal, null);
      return;
    }

    // Detect changes
    let hasChanges = false;
    inputs.forEach(function(input){
      if (input.getAttribute('data-child-input') === '1') {
        return;
      }
      const container = input.closest('[data-original-text]');
      const original = container ? String(container.getAttribute('data-original-text') || '').trim() : '';
      const current = String(input.value || '').trim();
      if (current !== original) { hasChanges = true; }
    });
    const childContainers = modal.querySelectorAll('[data-children-editor="1"]');
    childContainers.forEach(function(container) {
      const original = String(container.getAttribute('data-original-text') || '').trim();
      const current = String(collectChildrenValue(container) || '').trim();
      if (current !== original) { hasChanges = true; }
    });
    const educationSections = modal.querySelectorAll('[data-education-section]');
    educationSections.forEach(function(section) {
      const originalJson = section.getAttribute('data-original-json');
      if (!originalJson) return;
      const currentJson = JSON.stringify(getEducationEntriesFromSection(section));
      if (currentJson !== originalJson) { hasChanges = true; }
    });
    const workSection = modal.querySelector('[data-we-section]');
    if (workSection) {
      const originalWe = workSection.getAttribute('data-we-original-json');
      if (originalWe) {
        const currentWe = JSON.stringify(getWorkExperienceEntries(workSection));
        if (currentWe !== originalWe) { hasChanges = true; }
      }
    }
    const voluntarySection = modal.querySelector('[data-vw-section]');
    if (voluntarySection) {
      const originalVw = voluntarySection.getAttribute('data-vw-original-json');
      if (originalVw) {
        const currentVw = JSON.stringify(getVoluntaryWorkEntries(voluntarySection));
        if (currentVw !== originalVw) { hasChanges = true; }
      }
    }
    const learningDevSection = modal.querySelector('[data-ld-section]');
    if (learningDevSection) {
      const originalLd = learningDevSection.getAttribute('data-ld-original-json');
      if (originalLd) {
        const currentLd = JSON.stringify(getLearningDevEntries(learningDevSection));
        if (currentLd !== originalLd) { hasChanges = true; }
      }
    }
    const civilServiceSection = modal.querySelector('[data-cse-section]');
    if (civilServiceSection) {
      const originalCse = civilServiceSection.getAttribute('data-cse-original-json');
      if (originalCse) {
        const currentCse = JSON.stringify(getCivilServiceEntries(civilServiceSection));
        if (currentCse !== originalCse) { hasChanges = true; }
      }
    }
    if (!hasChanges) {
      // Nothing changed; simply exit edit mode
      exitEdit(modal, null);
      return;
    }

    // Show confirmation modal consistent with app design
    var cmEl = document.getElementById('profileSaveConfirmModal');
    var confirmBtn = document.getElementById('profileSaveConfirmBtn');
    var bodyEl = document.getElementById('profileSaveConfirmModalBody');
    if (bodyEl) {
      var header = modal.querySelector('#viewEmployeeModalLabel-' + employeeId);
      var name = header ? header.textContent : '';
      bodyEl.textContent = name ? ('Are you sure you want to save changes to "' + name + '"?') : 'Are you sure you want to save these changes?';
    }
    if (cmEl && confirmBtn && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      var inst = bootstrap.Modal.getInstance(cmEl) || new bootstrap.Modal(cmEl);
      var handler = function() {
        try { confirmBtn.removeEventListener('click', handler); } catch(e) {}
        if (document.activeElement === confirmBtn && typeof confirmBtn.blur === 'function') {
          confirmBtn.blur();
        }
        inst.hide();
        saveEdit(modal);
      };
      confirmBtn.addEventListener('click', handler);
      inst.show();
    } else {
      // Fallback to direct save if modal not available
      saveEdit(modal);
    }
  }

  async function saveEdit(modal) {
    const updateUrl = modal.getAttribute('data-update-url');
    const employeeId = modal.getAttribute('id').replace('viewEmployeeModal-', '');
    if (!updateUrl) return;

    // Block save if any invalid input (e.g., duplicate bio_number)
    const invalid = modal.querySelector('.pi-input.is-invalid');
    if (invalid) {
      invalid.focus();
      return;
    }

    // Collect values
    const inputs = modal.querySelectorAll('.pi-input');
    if (!inputs.length) {
      exitEdit(modal, null);
      return;
    }
    var fd = new FormData();
    fd.append('csrf_token', profileCsrf);
    inputs.forEach(function(input) {
      if (input.getAttribute('data-child-input') === '1') {
        return;
      }
      const key = input.getAttribute('data-key');
      if (!key) return;
      let val = (input.value || '').trim();
      fd.append(key, val);
    });
    let childrenValue = null;
    const childContainers = modal.querySelectorAll('[data-children-editor="1"]');
    childContainers.forEach(function(container) {
      childrenValue = collectChildrenValue(container);
    });
    if (childrenValue !== null) {
      fd.append('children_info', childrenValue);
    }
    const educationData = collectEducationData(modal);
    Object.keys(educationData).forEach(function(levelKey) {
      const prefix = EDUCATION_PREFIX_MAP[levelKey];
      if (!prefix) return;
      const jsonField = prefix + '_records_json';
      const entries = educationData[levelKey] || [];
      fd.append(jsonField, JSON.stringify(entries));
    });
    const workExperienceEntries = collectWorkExperienceData(modal);
    if (workExperienceEntries !== null) {
      fd.append('work_experience_json', JSON.stringify(workExperienceEntries));
    }
    const voluntaryWorkEntries = collectVoluntaryWorkData(modal);
    if (voluntaryWorkEntries !== null) {
      fd.append('voluntary_work_json', JSON.stringify(voluntaryWorkEntries));
    }
    const learningDevEntries = collectLearningDevData(modal);
    if (learningDevEntries !== null) {
      fd.append('learning_dev_json', JSON.stringify(learningDevEntries));
    }
    const civilServiceEntries = collectCivilServiceData(modal);
    if (civilServiceEntries !== null) {
      fd.append('civil_service_records_json', JSON.stringify(civilServiceEntries));
    }

    // Submit
    let res;
    try {
      res = await fetch(updateUrl, {
        method: 'POST',
        body: fd,
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': profileCsrf }
      });
    } catch (e) {
      // Network error, just exit edit without changes
      exitEdit(modal, null);
      return;
    }
    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      data = null;
    }
    if (res.ok && data && data.success) {
      // Update display name in header if provided
      try {
        const header = modal.querySelector('#viewEmployeeModalLabel-' + employeeId);
        if (header && data.employee_name) {
          header.textContent = data.employee_name;
        }
        // Update subtitle if bio/position/office changed (no optional chaining for compatibility)
        const subtitle = modal.querySelector('.text-white-50');
        if (subtitle && data.updated) {
          var subText = subtitle.textContent || '';
          var mBio = subText.match(/Biometric: ([^ •]+)/);
          var mPos = subText.match(/• ([^•]+) •/);
          var parts = subText.split('•');
          var lastPart = parts.length ? parts[parts.length - 1] : '';
          var bio = (typeof data.updated.bio_number !== 'undefined' && data.updated.bio_number !== null && data.updated.bio_number !== '')
            ? data.updated.bio_number
            : (mBio && mBio[1] ? mBio[1] : '');
          var posText = (mPos && mPos[1]) ? mPos[1] : '';
          var pos = (typeof data.updated.position !== 'undefined' && data.updated.position !== null && data.updated.position !== '')
            ? data.updated.position
            : posText.trim();
          var offText = lastPart ? String(lastPart).trim() : '';
          var off = (typeof data.updated.office !== 'undefined' && data.updated.office !== null && data.updated.office !== '')
            ? data.updated.office
            : offText;
          subtitle.textContent = 'Biometric: ' + bio + ' • ' + pos + ' • ' + off;
        }
      } catch (e) {}

      // Update table row cells immediately after save
      try {
        const row = document.querySelector('tr[data-employee-id="' + employeeId + '"]');
        if (row && data.updated) {
          const u = data.updated;

          // Biometric (col 0)
          if ('bio_number' in u && row.cells[0]) {
            row.cells[0].textContent = u.bio_number || '';
          }
          // Name (col 1)
          if (data.employee_name && row.cells[1]) {
            row.cells[1].textContent = data.employee_name;
          }
          // Office (col 2)
          if ('office' in u && row.cells[2]) {
            row.cells[2].textContent = u.office || '';
          }
          // Position (col 3) with badge styling
          if ('position' in u && row.cells[3]) {
            const posCell = row.cells[3];
            let badge = posCell.querySelector('.badge');
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'badge';
              posCell.innerHTML = '';
              posCell.appendChild(badge);
            }
            // reset and apply classes based on position
            badge.classList.remove('bg-info','text-dark','bg-primary','bg-secondary');
            const pos = u.position || '';
            if (pos === 'Job Order Worker') {
              badge.classList.add('bg-info','text-dark');
            } else if (pos === 'Contract of Service') {
              badge.classList.add('bg-primary');
            } else {
              badge.classList.add('bg-secondary');
            }
            badge.textContent = pos;
          }
          // Status (col 4) with badge styling
          if ('status' in u && row.cells[4]) {
            const stCell = row.cells[4];
            let sBadge = stCell.querySelector('.badge');
            if (!sBadge) {
              sBadge = document.createElement('span');
              sBadge.className = 'badge';
              stCell.innerHTML = '';
              stCell.appendChild(sBadge);
            }
            sBadge.classList.remove('bg-success','bg-secondary');
            const st = u.status || '';
            if (st === 'Active') {
              sBadge.classList.add('bg-success');
            } else {
              sBadge.classList.add('bg-secondary');
            }
            sBadge.textContent = st;
          }
        }
      } catch (e) {}

      // Update footer status badge if changed
      try {
        if (data.updated && 'status' in data.updated) {
          const footerBadge = modal.querySelector('.modal-footer .badge');
          if (footerBadge) {
            footerBadge.classList.remove('bg-success','bg-secondary');
            const st = data.updated.status || '';
            if (st === 'Active') footerBadge.classList.add('bg-success');
            else footerBadge.classList.add('bg-secondary');
            footerBadge.textContent = st || footerBadge.textContent;
          }
        }
      } catch (e) {}

      // Success notification: show global toast and also inline within the open modal
      try {
        var openModal = document.querySelector('.modal.show') || modal;
        if (openModal) {
          var bodyEl = openModal.querySelector('.modal-body');
          if (bodyEl) {
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = '<strong>Saved.</strong> Changes were saved successfully.'
              + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            bodyEl.insertBefore(alertDiv, bodyEl.firstChild);
            setTimeout(function(){ try { alertDiv.classList.remove('show'); alertDiv.remove(); } catch(e){} }, 2500);
          }
        }
        if (typeof window.showToast === 'function') {
          window.showToast('Employee profile saved successfully', 'success');
        }
      } catch (e) {}

      const updated = data.updated || {};
      exitEdit(modal, updated);
    } else {
      // On error, revert
      exitEdit(modal, null);
    }
  }

  // Event delegation for Edit/Save button
  document.addEventListener('click', function(ev) {
    const btn = ev.target.closest('[data-action="toggle-edit"]');
    if (!btn) return;
    const modal = btn.closest('.modal');
    if (!modal) return;
    const editing = modal.getAttribute('data-editing') === '1';
    if (!editing) {
      // Enter edit mode
      enterEdit(modal);
    } else {
      // Save with confirmation modal
      requestSave(modal);
    }
  });
})();
</script>
{% endblock %}
